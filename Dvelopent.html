<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Menu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="img/ico.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style1.css">
    <script src="js/sitefun.js" type="module"></script>
    <script src="js/user.js"></script>
    <style>
        /* Общие стили для нового макета, скопированные из accunt.html */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1f1d1d; /* Будет переопределено JS */
            margin: 0;
            padding-top: 60px;
            display: flex;
            min-height: 100vh;
        }

        /* ------------------------------------- */
        /* Боковое меню (Sidebar) - accunt.html Style */
        /* ------------------------------------- */
        nav {
            background-color: #2b2c2e; /* Будет переопределено JS */
            width: 250px;
            min-width: 200px;
            padding: 10px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            position: fixed;
            height: 100%;
            color: #ffffff;
            overflow-y: auto;
            top: 0;
            left: 0;
            z-index: 99;
            box-sizing: border-box;
            padding-top: 70px;
        }
        nav.active {
            transform: translateX(0); /* Для мобильного меню */
            box-shadow: 5px 0 10px rgba(0, 0, 0, 0.3);
        }

        /* Заголовок кластера */
        .cluster-title {
            color: #A9B2BB; /* Будет переопределено JS */
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 15px 15px 5px 15px;
            margin-top: 5px;
        }

        /* Разделитель */
        .cluster-separator {
            border: none;
            height: 1px;
            background-color: #444C56; /* Будет переопределено JS */
            margin: 5px 15px;
        }

        /* Стиль ссылок в боковом меню */
        nav a {
            text-decoration: none;
            display: block;
            margin: 0;
            color: #C8D1D9; /* Будет переопределено JS */
            font-size: 15px;
            padding: 10px 15px;
            border-left: 3px solid transparent;
            transition: background-color 0.2s, border-left-color 0.2s, color 0.2s;
        }

        /* Основная область контента */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
            box-sizing: border-box;
            color: inherit;
        }
        
        .main-content h1 {
            border-bottom: 1px solid #444C56; 
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #FFFFFF; 
        }
        .main-content h2 {
            margin-top: 0;
            font-size: 24px;
            color: inherit;
        }
        .main-content p {
            color: inherit;
        }

        /* Верхняя панель (Top Panel) - accunt.html */
        .top-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #191919; /* Будет переопределено JS */
            color: white; /* Будет переопределено JS */
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .toggleButton {
            background: none;
            border: none;
            color: inherit;
            font-size: 24px;
            cursor: pointer;
            display: none; 
        }
        
        .user-widget:hover {
            background-color: #3C444B; 
        }
        .user-widget-info {
            margin-left: 10px;
            font-size: 14px;
            text-align: right;
            color: inherit;
        }
        .user-widget-info .name {
            font-weight: 600;
            color: #000000; 
        }
        .user-widget-info .pcoin {
            font-weight: 600;
            color: #000000; 
        }
        .user-widget-info .email {
            font-weight: 600;
            color: #000000; 
        }
        .user-icn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid transparent;
        }
        #userMenu {
            position: fixed;
            right: 15px; 
            top: 60px; 
            z-index: 1000; 
            background: #191919;
            border: 1px solid #444C56;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); 
            padding: 10px; 
            border-radius: 8px; 
            text-align: left;
            min-width: 180px;
        }
        #userMenu button {
            display: block; 
            width: 100%; 
            margin-bottom: 5px;
            padding: 8px 15px;
            border: none;
            background: #2b2c2e;
            color: #FFFFFF;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s, color 0.2s;
        }
        #userMenu button:hover {
            background: #444C56;
        }

        /* Developer Menu Content Styles (Adapted to accunt.html inputs/buttons) */
        .settings-container label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: inherit; 
        }
        .settings-container input[type="text"] {
             width: 100%;
             max-width: 400px;
             padding: 10px;
             margin: 5px 0;
             border: 1px solid #ccc; 
             border-radius: 6px;
             box-sizing: border-box;
             background-color: inherit; 
             color: inherit; 
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-container input[type="text"]:focus {
            border-color: #0366D6; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.5);
        }
        /* Style for the main action buttons in content area */
        .dev-action-buttons .button {
            display: block;
            width: 100%;
            max-width: 400px; /* Ограничиваем ширину для лучшего вида */
            margin-bottom: 10px;
            background-color: #1a73e8 !important; 
            color: white !important;
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 16px;
            text-align: center;
        }
        .dev-action-buttons .button:hover {
            background-color: #0c5dc0 !important;
        }
        .dev-action-buttons .button:nth-child(4) { /* View/Manage My Projects */
            background-color: #6c757d !important;
        }
        .dev-action-buttons .button:nth-child(4):hover {
            background-color: #5a6268 !important;
        }
        /* App item in content area */
        .appItem-content {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #444C56;
            border-radius: 6px;
            background-color: #2b2c2e;
            margin-top: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            max-width: 400px;
        }
        .appItem-content:hover {
            background-color: #3C444B;
        }
        .appItem-content img {
            width: 32px;
            height: 32px;
            margin-right: 15px;
        }
        .appItem-content span {
            font-weight: 600;
        }


        /* NEW MODAL STYLES (Adapted from Dvelopent.html, but styled for dark theme) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #2b2c2e; /* Nav-bg equivalent */
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-sizing: border-box;
            text-align: left;
            max-height: 90vh;
            overflow-y: auto;
            color: #FFFFFF;
            border: 1px solid #444C56;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
            border: 1px solid #444C56;
            border-radius: 6px;
            background: #1f1d1d; /* Body-bg equivalent */
            color: #FFFFFF;
            box-sizing: border-box;
        }
        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .modal-buttons button:first-child { /* Cancel */
            background-color: #444C56;
            color: #FFFFFF;
        }
        .modal-buttons button:first-child:hover {
            background-color: #5a6268;
        }
        .modal-buttons button:last-child { /* Confirm/Save */
            background-color: #0366D6;
            color: #FFFFFF;
        }
        .modal-buttons button:last-child:hover {
            background-color: #005cbf;
        }
        
        .project-item {
            border: 1px solid #444C56;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: #1f1d1d;
        }
        .project-filter button.active {
            background-color: #0366D6;
            color: white;
            border-color: #0366D6;
        }
        /* End of modal styles */


        /* Медиа-запросы для мобильных устройств (accunt.html) */
        @media (max-width: 768px) {
            body {
                padding-top: 50px;
                flex-direction: column;
            }
            .top-panel {
                height: 50px;
                justify-content: flex-start;
                gap: 10px;
                padding: 0 10px;
            }
            .toggleButton {
                display: block; 
            }
            .user-widget {
                margin-left: auto;
            }
            .user-widget-info {
                display: none;
            }
            nav {
                position: fixed;
                width: 80vw;
                height: 100vh;
                padding-top: 50px;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
                width: 100%;
            }
            .dev-action-buttons .button, .appItem-content {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    
    <div class="top-panel">
        <button class="toggleButton" onclick="toggleNavMenu()">☰</button>
        <div style="font-size: 20px; font-weight: bold;">Developer Menu</div>
        
        <div class="user-widget" onclick="toggleUserMenu()">
            <img class="user-icn" id="topUserIcon" src="https://cdn-icons-png.flaticon.com/128/17807/17807725.png" alt="Profile Icon">
            <div class="user-widget-info">
                <div class="name" id="topUserName">User Name</div>
                <div class="email" id="topUserEmail"></div>
                <div class="pcoin" id="topUserPcoin">Pcoin 0</div>
            </div>
        </div>
        
        <div class="user-menu" id="userMenu" style="display: none;">
            <button onclick="window.location.href='accunt'">Setings</button>
            <button onclick="window.location.href='accunt'">top up balance Pcoin</button>
            <button onclick="window.location.href='riegist'">register or login</button>
        </div>
    </div>
    
    <nav id="settingsNav"></nav>

    <div class="main-content" id="mainContent">
        </div>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add Search</h3>
            <div id="modal-fields">
                <input type="text" name="searchName" placeholder="Search Name" required>
                <input type="text" name="searchUrl" placeholder="Search URL" required>
                <input type="text" name="searchdata" placeholder="Search data" required>
            </div>
            <div class="modal-buttons">
                <button onclick="document.getElementById('modal').style.display='none'">Cancel</button>
                <button onclick="confirmChanges('search')">Confirm</button>
            </div>
        </div>
    </div>

    <div id="modal1" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">creating an article</h3>
            <div id="modal1-fields">
                <input type="text" name="Name" placeholder="Name" required>
                <input type="text" name="img" placeholder="img" required>
                <input type="text" name="code" placeholder="code" required>
            </div>
            <div class="modal-buttons">
                <button onclick="document.getElementById('modal1').style.display='none'">Cancel</button>
                <button onclick="confirmChanges('datapedia')">Confirm</button>
            </div>
        </div>
    </div>

    <div id="modal2" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add Game/App</h3>
            <div id="modal2-fields">
                <input type="text" name="Name" placeholder="Name" required>
                <input type="text" name="price" placeholder="price" required>
                <input type="text" name="image" placeholder="image URL" required>
                <input type="text" name="installURL" placeholder="Install URL" required> </div>
            <div class="modal-buttons">
                <button onclick="document.getElementById('modal2').style.display='none'">Cancel</button>
                <button onclick="confirmChanges('gameApp')">Confirm</button>
            </div>
        </div>
    </div>

    <div id="modal3" class="modal">
        <div class="modal-content">
            <h3>My Projects</h3>
            <div class="project-filter">
                <button id="filter-all" class="active" onclick="showProjects('all')">All</button>
                <button id="filter-search" onclick="showProjects('search')">Search</button>
                <button id="filter-datapedia" onclick="showProjects('datapedia')">Datapedia</button>
                <button id="filter-gameApp" onclick="showProjects('gameApp')">Games/Apps</button>
            </div>
            <div id="projects-list">
                <p>No projects found. Add some projects using the buttons above!</p>
            </div>
            <div class="modal-buttons">
                <button onclick="document.getElementById('modal3').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <div id="editSearchModal" class="modal">
        <div class="modal-content">
            <h3>Edit Search Project</h3>
            <div id="editSearchFields">
                <input type="hidden" id="editSearchOriginalString"> 
                <label for="editSearchName">Search Name:</label>
                <input type="text" id="editSearchName" placeholder="Search Name" required>
                <label for="editSearchUrl">Search URL:</label>
                <input type="text" id="editSearchUrl" placeholder="Search URL" required>
                <label for="editSearchData">Search Data:</label>
                <input type="text" id="editSearchData" placeholder="Search data" required>
            </div>
            <div class="modal-buttons">
                <button onclick="document.getElementById('editSearchModal').style.display='none'">Cancel</button>
                <button onclick="saveProjectChanges('search')">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="editDatapediaModal" class="modal">
        <div class="modal-content">
            <h3>Edit Datapedia Article</h3>
            <div id="editDatapediaFields">
                <input type="hidden" id="editDatapediaOriginalString"> 
                <label for="editDatapediaName">Article Name:</label>
                <input type="text" id="editDatapediaName" placeholder="Name" required>
                <label for="editDatapediaImg">Image URL:</label>
                <input type="text" id="editDatapediaImg" placeholder="img" required>
                <label for="editDatapediaCode">Code:</label>
                <input type="text" id="editDatapediaCode" placeholder="code" required>
            </div>
            <div class="modal-buttons">
                <button onclick="document.getElementById('editDatapediaModal').style.display='none'">Cancel</button>
                <button onclick="saveProjectChanges('datapedia')">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="editGameAppModal" class="modal">
        <div class="modal-content">
            <h3>Edit Game/App Project</h3>
            <div id="editGameAppFields">
                <input type="hidden" id="editGameAppOriginalId"> <label for="editGameAppName">Name:</label>
                <input type="text" id="editGameAppName" placeholder="Name" required>
                <label for="editGameAppPrice">Price:</label>
                <input type="text" id="editGameAppPrice" placeholder="price" required>
                <label for="editGameAppImage">Image URL:</label>
                <input type="text" id="editGameAppImage" placeholder="image URL" required>
                <label for="editGameAppInstallURL">Install URL:</label>
                <input type="text" id="editGameAppInstallURL" placeholder="Install URL" required>
                </div>
            <div class="modal-buttons">
                <button onclick="document.getElementById('editGameAppModal').style.display='none'">Cancel</button>
                <button onclick="saveProjectChanges('gameApp')">Save Changes</button>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script type="module">
    
    // ***************************************************************
    // 1. ИМПОРТЫ МОДУЛЕЙ
    // ***************************************************************
    import "./js/firebase_db.js"; 
    import { PDrive } from "./js/PDrive.js"; 
    
    // Если ваши файлы с логикой тоже модули, импортируйте их здесь.
    // Убедитесь, что пути правильные:
    // import * as PP_Search from "./js/ppsearch.js"; 
    // import * as PP_Play from "./js/ppplay.js"; 
    // import * as PP_Datapedia from "./js/ppdatapedia.js"; 

    // ----------------------------------------------------------------------------------
    // 2. ГЛОБАЛИЗАЦИЯ ФУНКЦИЙ
    // 
    // ЭТО ИСПРАВЛЯЕТ ВЫЗОВЫ ONCLICK ИЗ HTML (Dvelopent.html:420 и т.д.)
    // ----------------------------------------------------------------------------------
    window.confirmChanges = async (projectType) => confirmChanges(projectType);
    window.showProjects = async (filterType) => showProjects(filterType);
    window.deleteProject = async (projectIdentifier, projectType) => deleteProject(projectIdentifier, projectType);
    window.editProject = async (projectIdentifier, projectType) => editProject(projectIdentifier, projectType);
    window.saveProjectChanges = async (projectType) => saveProjectChanges(projectType);
    
    // Глобализация функций UI
    window.toggleUserMenu = function() {
        const userMenu = document.getElementById('userMenu');
        const nav = document.getElementById('settingsNav');
        const isNavOpen = nav.classList.contains('active');
        if (isNavOpen && window.innerWidth <= 768) {
            nav.classList.remove('active');
        }
        userMenu.style.display = (userMenu.style.display === 'block') ? 'none' : 'block';
    }

    window.toggleNavMenu = function() {
        const nav = document.getElementById('settingsNav');
        const userMenu = document.getElementById('userMenu');
        const isUserMenuOpen = userMenu.style.display === 'block';
        if (isUserMenuOpen) {
            userMenu.style.display = 'none';
        }
        nav.classList.toggle('active');
    }
    
    window.openApp = function(url) { console.log("Opening app:", url); window.location.href = url; }
    window.toggleMenu = function() {
        const menu = document.getElementById('menuContainer');
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    }


    // -----------------------------------------------------
    // 3. БЛОК ЛОГИКИ PDrive (ВСЕ ФУНКЦИИ, КОТОРЫЕ ИСПОЛЬЗУЮТ PDrive)
    // -----------------------------------------------------

    let allUserData = {
        search: [],
        datapedia: [],
        gameApp: []
    };
    
    let userName = getCookie('name') || 'guest';
    const PROJECTS_FILE_PATH = `/dev-projects/${userName}-projects.json`; 


    // 1. Асинхронное чтение файла проектов
    async function readProjectsFile() {
        try {
            // PDrive теперь доступен, так как находится в области видимости модуля!
            const pdrive = new PDrive(userName); 

            const fileContent = await pdrive.readFile(PROJECTS_FILE_PATH);
            
            if (fileContent) {
                const data = JSON.parse(fileContent);
                
                const parseProjectData = (dataString, type) => {
                    if (!dataString || typeof dataString !== 'string') return [];
                    return dataString.split('|').filter(s => s.trim() !== '').map(projectString => {
                        const parts = projectString.split('~');
                        let project = { originalString: projectString, type: type };
                        
                        switch (type) {
                            case 'search':
                                if (parts.length >= 3) {
                                    project.id = projectString;
                                    project.name = parts[0].trim();
                                    project.url = parts[1].trim();
                                    project.data = parts[2].trim();
                                }
                                break;
                            case 'datapedia':
                                if (parts.length >= 3) {
                                    project.id = projectString;
                                    project.name = parts[0].trim();
                                    project.img = parts[1].trim();
                                    project.code = parts[2].trim();
                                }
                                break;
                            case 'gameApp':
                                if (parts.length >= 7) {
                                    project.id = parseInt(parts[0]);
                                    project.name = parts[1].trim();
                                    project.price = parseFloat(parts[2]);
                                    project.image = parts[3].trim();
                                    project.owned = parts[4] === "true";
                                    project.installed = parts[5] === "true";
                                    project.installURL = parts[6].trim();
                                } else if (parts.length >= 4) {
                                    // Старый формат, где ID будет отсутствовать
                                    project.id = projectString; // Временный ID для старых записей
                                    project.name = parts[0].trim();
                                    project.price = parseFloat(parts[1]);
                                    project.image = parts[2].trim();
                                    project.installURL = parts[3].trim(); 
                                    project.owned = false; 
                                    project.installed = false; 
                                }
                                break;
                        }
                        return (type === 'gameApp' && project.id === undefined) ? null : project; 
                    }).filter(p => p !== null); 
                };
                
                allUserData.search = parseProjectData(data.search, 'search');
                allUserData.datapedia = parseProjectData(data.datapedia, 'datapedia');
                allUserData.gameApp = parseProjectData(data.gameApp, 'gameApp');
                
                console.log("Projects loaded from PDrive:", allUserData);
            }
        } catch (error) {
            // Эта ошибка теперь не будет ReferenceError, а, возможно, ошибкой чтения файла
            console.warn("Could not read projects file, creating new structure if necessary:", error); 
        }
    }


    // 2. Асинхронная запись файла проектов
    async function writeProjectsFile() {
        try {
            const pdrive = new PDrive(userName);

            const dataToSave = {
                search: allUserData.search.map(p => `${p.name}~${p.url}~${p.data}`).join('|'),
                datapedia: allUserData.datapedia.map(p => `${p.name}~${p.img}~${p.code}`).join('|'),
                gameApp: allUserData.gameApp.map(p => `${p.id}~${p.name}~${p.price}~${p.image}~${p.owned ? 'true' : 'false'}~${p.installed ? 'true' : 'false'}~${p.installURL}`).join('|')
            };

            const jsonContent = JSON.stringify(dataToSave, null, 2);
            await pdrive.writeFile(PROJECTS_FILE_PATH, jsonContent);
            console.log("Projects saved to PDrive successfully.");
        } catch (error) {
            console.error("Error saving projects to PDrive:", error);
            alert("Failed to save projects to file system. Please try again.");
            throw error;
        }
    }

    // [Остальная часть логики: confirmChanges, showProjects, deleteProject, editProject, saveProjectChanges, а также функции applyTheme, getCookie, updateSettingsList, showSettingsSection, updateUserInfo и инициализационный самовызывающийся блок (async function() { ... })] 
    // Вся эта логика должна быть включена ЗДЕСЬ, в ЕДИНОМ блоке <script type="module">
    
    // --- ВАЖНО: Весь код из предыдущего ответа должен быть здесь ---
    
    // --- Theme Styles и Утилиты ---
    const themeStyles = {
        'dark': {
            'body-bg': '#1f1d1d', 'text-color': '#FFFFFF',
            'top-panel-bg': '#191919', 'top-panel-color': '#FFFFFF',
            'nav-bg': '#2b2c2e', 'nav-text': '#FFFFFF',
            'nav-hover': '#444C56', 'nav-active-bg': '#3C444B',
            'cluster-title': '#FFFFFF', 'input-color': '#DDDDDD',
            'main-content-h2': '#FFFFFF', 'link-accent': '#0366D6', 
            'app-item-bg': '#2b2c2e', 'app-item-hover': '#3C444B'
        },
        'white': {
            'body-bg': '#FFFFFF', 'text-color': '#333333',
            'top-panel-bg': '#FFFFFF', 'top-panel-color': '#333333',
            'nav-bg': '#FFFFFF', 'nav-text': '#333333',
            'nav-hover': '#F0F0F0', 'nav-active-bg': '#E0E0E0',
            'cluster-title': '#888888', 'input-color': '#333',
            'main-content-h2': '#000', 'link-accent': '#007bff', 
            'app-item-bg': '#FFFFFF', 'app-item-hover': '#E0E0E0'
        },
        'gray': {
            'body-bg': '#CCCCCC', 'text-color': '#111111',
            'top-panel-bg': '#3C444B', 'top-panel-color': '#EBEBEB',
            'nav-bg': '#555C66', 'nav-text': '#EBEBEB',
            'nav-hover': '#6E7985', 'nav-active-bg': '#505760',
            'cluster-title': '#C0C8D0', 'input-color': '#333',
            'main-content-h2': '#222', 'link-accent': '#00BFFF', 
            'app-item-bg': '#D7D7D7', 'app-item-hover': '#C0C0C0'
        }
    };

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    function applyTheme(themeName) {
        const theme = themeStyles[themeName];
        if (!theme) return;

        document.body.style.backgroundColor = theme['body-bg'];
        document.body.style.color = theme['text-color'];
        
        const topPanel = document.querySelector('.top-panel');
        if (topPanel) {
            topPanel.style.backgroundColor = theme['top-panel-bg'];
            topPanel.style.color = theme['top-panel-color'];
        }
        
        let styleSheet = document.getElementById('theme-style');
        if (!styleSheet) {
            styleSheet = document.createElement('style');
            styleSheet.id = 'theme-style';
            document.head.appendChild(styleSheet);
        }
        styleSheet.textContent = `
            /* Dynamic Theme Overrides for ${themeName} */
            .main-content h1, .main-content h2, .settings-container label { color: ${theme['input-color']} !important; }
            .main-content h1 { border-bottom-color: ${theme['nav-hover']} !important; }
            .main-content { background-color: ${theme['body-bg']} !important; }

            /* Навигация */
            #settingsNav { background-color: ${theme['nav-bg']} !important; }
            nav a { color: ${theme['nav-text']} !important; border-left-color: transparent !important; }
            nav a:hover { background-color: ${theme['nav-hover']} !important; color: ${theme['top-panel-color']} !important; }
            nav a.active { background-color: ${theme['nav-active-bg']} !important; border-left-color: ${theme['link-accent']} !important; color: ${theme['top-panel-color']} !important; }
            .cluster-separator { background-color: ${theme['nav-hover']} !important; }
            .cluster-title { color: ${theme['cluster-title']} !important; }
            
            /* Поля ввода и кнопки в контенте */
            .settings-container input[type="text"] {
                background-color: ${theme['body-bg']} !important;
                color: ${theme['text-color']} !important;
                border-color: ${theme['cluster-title']} !important;
            }
            .settings-container input[type="text"]:focus {
                border-color: ${theme['link-accent']} !important;
                box-shadow: 0 0 0 3px ${theme['link-accent']}4D !important;
            }
            .dev-action-buttons .button {
                background-color: ${theme['link-accent']} !important;
                color: #FFFFFF !important;
            }
            .dev-action-buttons .button:nth-child(4) { 
                background-color: ${theme['nav-hover']} !important;
            }

            /* App item in content area */
            .appItem-content {
                background-color: ${theme['app-item-bg']} !important; 
                border-color: ${theme['nav-hover']} !important; 
                color: ${theme['text-color']} !important;
            }
            .appItem-content:hover {
                background-color: ${theme['app-item-hover']} !important;
            }
            
            /* Модальные окна */
            .modal-content { background: ${theme['nav-bg']} !important; border-color: ${theme['nav-hover']} !important; color: ${theme['text-color']} !important; }
            .modal input { background: ${theme['body-bg']} !important; color: ${theme['text-color']} !important; border-color: ${theme['nav-hover']} !important; }
            .project-item { background-color: ${theme['body-bg']} !important; border-color: ${theme['nav-hover']} !important; }
            .modal-buttons button:last-child { background-color: ${theme['link-accent']} !important; }
            .project-filter button.active { background-color: ${theme['link-accent']} !important; border-color: ${theme['link-accent']} !important; }
            
            /* Меню пользователя */
            #userMenu { background-color: ${theme['nav-bg']} !important; border-color: ${theme['nav-hover']} !important; }
            #userMenu button { background-color: ${theme['body-bg']} !important; color: ${theme['text-color']} !important; border: 1px solid ${theme['nav-hover']} !important; }
            #userMenu button:hover { background-color: ${theme['nav-hover']} !important; color: ${theme['top-panel-color']} !important; }
            .top-panel div[style*="font-weight: bold;"] { color: ${theme['top-panel-color']} !important; }
            .user-widget-info .name { color: ${theme['link-accent']} !important; }
            .toggleButton { color: ${theme['top-panel-color']} !important; }
        `;
    }
    
    const settingsSections = {
        'Overview': {
            title: 'Overview & Quick Actions',
            html: `
                <div class="settings-container">
                    <h2>Developer Tools and Shortcuts</h2>
                    <p>Use the buttons below to quickly add new projects or manage existing ones.</p>
                    
                    <div class="dev-action-buttons">
                        <button class="button" onclick="document.getElementById('modal').style.display='flex'">add Search</button>
                        <button class="button" onclick="document.getElementById('modal1').style.display='flex'">Add article to datapedia</button>
                        <button class="button" onclick="document.getElementById('modal2').style.display='flex'">add a game or app to Parrot Play</button>
                        <button class="button" onclick="showProjects('all'); document.getElementById('modal3').style.display='flex'">View/Manage My Projects</button>
                    </div>
                    
                    <h3 style="margin-top: 30px; border-bottom: 1px solid #444C56; padding-bottom: 10px;">Quick Launch</h3>
                    
                    <div class="appItem-content" onclick="openApp('ParrotSoftIDE.html')">
                        <img src="img/ParrotIDE_mini.png" alt="ParrotIDE Icon">
                        <span>ParrotSoftIDE</span>
                    </div>
                </div>
            `
        },
        'NewContent': {
            title: 'Add New Content',
            html: `
                <div class="settings-container">
                    <h2>Add Content Wizards</h2>
                    <p>Launch specific creation wizards using the links below:</p>
                    <div style="margin-top: 20px;">
                        <button class="button" onclick="document.getElementById('modal').style.display='flex'">Add Search Engine</button>
                        <button class="button" onclick="document.getElementById('modal1').style.display='flex'">Create Datapedia Article</button>
                        <button class="button" onclick="document.getElementById('modal2').style.display='flex'">Publish Game or App</button>
                    </div>
                </div>
            `
        },
    };
    const navClusters = [
        {
            title: 'ACCOUNT',
            id: 'account',
            items: [
                { id: 'Styling', title: 'Account Styling', type: 'link', url: 'accunt.html' },
                { id: 'Theme', title: 'Design Theme', type: 'link', url: 'accunt.html' }, 
                { id: 'Security', title: 'Password and Security', type: 'link', url: 'accunt.html' },
                { id: 'Deletion', title: 'Delete Account', type: 'link', url: 'accunt.html' }, 
            ]
        },
        {
            title: 'FINANCES',
            id: 'financial',
            items: [
                { id: 'PcoinWallet', title: 'P-coin Wallet', type: 'link', url: 'Pcoin.html' },
            ]
        },{
            title: 'DEVELOPMENT MENU',
            id: 'development',
            items: [
                { id: 'Overview', title: 'Overview & Actions', type: 'section' },
                { id: 'NewContent', title: 'New Content Wizards', type: 'section' },
            ]
        },
        {
            title: 'MANAGEMENT',
            id: 'management',
            items: [
                { id: 'manageProjects', title: 'Manage Projects', type: 'section', action: "showProjects('all'); document.getElementById('modal3').style.display='flex'" },
                { id: 'ParrotSoftIDE', title: 'ParrotSoftIDE', type: 'link', url: 'ParrotSoftIDE.html' },
            ]
        }
    ];

    function updateSettingsList() {
        const nav = document.getElementById('settingsNav');
        nav.innerHTML = '';
        
        navClusters.forEach((cluster, clusterIndex) => {
            if (clusterIndex > 0) {
                 const separator = document.createElement('hr');
                 separator.className = 'cluster-separator';
                 nav.appendChild(separator);
            }
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'cluster-title';
            titleDiv.textContent = cluster.title;
            nav.appendChild(titleDiv);

            cluster.items.forEach(item => {
                const link = document.createElement('a');
                link.textContent = item.title;
                
                if (item.type === 'section') {
                    link.href = '#';
                    link.setAttribute('data-section', item.id);
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        if(item.action) {
                            window.eval(item.action); 
                        } else {
                            showSettingsSection(item.id);
                        }
                        if (window.innerWidth <= 768) {
                            document.getElementById('settingsNav').classList.remove('active');
                        }
                    });
                } else if (item.type === 'link') {
                    link.href = item.url;
                }

                nav.appendChild(link);
            });
        });
        applyTheme(getCookie('theme') || 'dark');
    }

    function showSettingsSection(sectionId) {
        const mainContent = document.getElementById('mainContent');
        const navLinks = document.querySelectorAll('#settingsNav a[data-section]');

        navLinks.forEach(link => {
            link.classList.toggle('active', link.getAttribute('data-section') === sectionId);
        });

        mainContent.innerHTML = settingsSections[sectionId].html;
        applyTheme(getCookie('theme') || 'dark');
    }
    
    function updateUserInfo() {
        document.getElementById('topUserName').textContent = getCookie('name') || 'Guest';
        document.getElementById('topUserEmail').textContent = getCookie('email') || 'Not logged in';
        document.getElementById('topUserPcoin').textContent = "Pcoin " + (getCookie('p-coin') || '0');
        document.getElementById('topUserIcon').src = getCookie('icon') || "https://cdn-icons-png.flaticon.com/128/17807/17807725.png";
    }

    document.addEventListener('click', function(event) {
        const userMenu = document.getElementById('userMenu');
        const userWidget = document.querySelector('.user-widget');
        const nav = document.getElementById('settingsNav');

        if (userMenu && userWidget && !userWidget.contains(event.target) && !userMenu.contains(event.target)) {
            userMenu.style.display = 'none';
        }

        if (window.innerWidth <= 768 && nav && nav.classList.contains('active') && !nav.contains(event.target) && !document.querySelector('.toggleButton').contains(event.target)) {
            nav.classList.remove('active');
        }
    });
    
    // 3. Универсальная функция для добавления проекта
    async function confirmChanges(projectType) {
        let modalId, fieldsSelector, newEntryParts = [];

        switch (projectType) {
            case 'search':
                modalId = 'modal';
                fieldsSelector = '#modal-fields input';
                break;
            case 'datapedia':
                modalId = 'modal1';
                fieldsSelector = '#modal1-fields input';
                break;
            case 'gameApp':
                modalId = 'modal2';
                fieldsSelector = '#modal2-fields input';
                break;
            default:
                console.error("Unknown project type:", projectType);
                return;
        }

        const modal = document.getElementById(modalId);
        const fields = document.querySelectorAll(fieldsSelector);
        
        let allFieldsFilled = true;
        fields.forEach(field => {
            if (field.value.trim() === '') {
                allFieldsFilled = false;
            }
            newEntryParts.push(field.value.trim());
        });

        if (!allFieldsFilled) {
            alert('All fields are required!');
            return;
        }

        let newProject = { type: projectType };

        if (projectType === 'gameApp') {
            newProject.id = Date.now();
            newProject.name = newEntryParts[0];
            newProject.price = parseFloat(newEntryParts[1]);
            newProject.image = newEntryParts[2];
            newProject.installURL = newEntryParts[3];
            newProject.owned = false;
            newProject.installed = false;
            newProject.originalString = `${newProject.id}~${newProject.name}~${newProject.price}~${newProject.image}~${newProject.owned ? 'true' : 'false'}~${newProject.installed ? 'true' : 'false'}~${newProject.installURL}`;
            
        } else if (projectType === 'search') {
            newProject.name = newEntryParts[0];
            newProject.url = newEntryParts[1];
            newProject.data = newEntryParts[2];
            newProject.originalString = `${newProject.name}~${newEntryParts[1]}~${newEntryParts[2]}`;
            newProject.id = newProject.originalString;

        } else if (projectType === 'datapedia') {
            newProject.name = newEntryParts[0];
            newProject.img = newEntryParts[1];
            newProject.code = newEntryParts[2];
            newProject.originalString = `${newProject.name}~${newEntryParts[1]}~${newEntryParts[2]}`;
            newProject.id = newProject.originalString;
        }
        
        allUserData[projectType].push(newProject);

        try {
            await writeProjectsFile();
            console.log(`Changes confirmed (${projectType}):`, newProject);
            modal.style.display = 'none';
            alert('Project added successfully!');
            fields.forEach(field => field.value = '');
        } catch (error) {
            // writeProjectsFile уже выводит ошибку
        }
    }
    
    // 4. Адаптируем showProjects
    async function showProjects(filterType = 'all') {
        const projectsListDiv = document.getElementById('projects-list');
        projectsListDiv.innerHTML = '';

        document.querySelectorAll('.project-filter button').forEach(btn => {
            btn.classList.remove('active');
        });
        const filterButton = document.getElementById(`filter-${filterType}`);
        if (filterButton) {
            filterButton.classList.add('active');
        } else {
            document.getElementById('filter-all').classList.add('active');
        }

        await readProjectsFile(); 
        
        let filteredProjects = allUserData.search.concat(allUserData.datapedia, allUserData.gameApp);

        if (filterType !== 'all') {
            filteredProjects = filteredProjects.filter(p => p.type === filterType);
        }

        if (filteredProjects.length === 0) {
            projectsListDiv.innerHTML = `<p>No ${filterType !== 'all' ? filterType : ''} projects found.</p>`;
        } else {
            filteredProjects.forEach(project => {
                const projectDiv = document.createElement('div');
                projectDiv.classList.add('project-item');

                let detailsHtml = '';
                let identifier = project.id; 

                switch (project.type) {
                    case 'search':
                        detailsHtml = `
                            <h4>${project.name} <span style="font-size: 0.8em; color: #888;">(Search)</span></h4>
                            <p>URL: <a href="${project.url}" target="_blank">${project.url}</a></p>
                            <p>Data: ${project.data}</p>
                        `;
                        break;
                    case 'datapedia':
                        detailsHtml = `
                            <h4>${project.name} <span style="font-size: 0.8em; color: #888;">(Datapedia Article)</span></h4>
                            <p>Image: <a href="${project.img}" target="_blank">${project.img}</a></p>
                            <p>Code: ${project.code}</p>
                        `;
                        break;
                    case 'gameApp':
                        detailsHtml = `
                            <h4>${project.name} <span style="font-size: 0.8em; color: #888;">(Game/App)</span></h4>
                            <p>ID: ${project.id}</p>
                            <p>Price: ${project.price}</p>
                            <p>Image: <a href="${project.image}" target="_blank">${project.image}</a></p>
                            <p>Install URL: <a href="${project.installURL}" target="_blank">${project.installURL}</a></p>
                            <p>Status: Owned: ${project.owned ? 'Yes' : 'No'}, Installed: ${project.installed ? 'Yes' : 'No'}</p>
                        `;
                        break;
                }

                const escapedIdentifier = String(identifier).replace(/'/g, "\\'");
                
                projectDiv.innerHTML = `
                    ${detailsHtml}
                    <div class="actions">
                        <button onclick="editProject('${escapedIdentifier}', '${project.type}')">Edit</button>
                        <button class="delete-btn" onclick="deleteProject('${escapedIdentifier}', '${project.type}')">Delete</button>
                    </div>
                `;
                projectsListDiv.appendChild(projectDiv);
            });
        }
        document.getElementById('modal3').style.display = 'flex';
    }


    // 5. Универсальная функция для удаления проекта
    async function deleteProject(projectIdentifier, projectType) {
        if (!confirm(`Are you sure you want to delete this ${projectType} project?`)) {
            return;
        }

        await readProjectsFile();

        const initialLength = allUserData[projectType].length;

        if (projectType === 'gameApp') {
            const idToDelete = parseInt(projectIdentifier);
            allUserData.gameApp = allUserData.gameApp.filter(p => p.id !== idToDelete);
        } else {
            allUserData[projectType] = allUserData[projectType].filter(p => p.id !== projectIdentifier);
        }
        
        if (allUserData[projectType].length < initialLength) {
            try {
                await writeProjectsFile();
                alert(`${projectType} project deleted successfully!`);
                showProjects(projectType);
            } catch (error) {
            }
        } else {
            alert(`Project not found for deletion.`);
        }
    }

    // 6. Универсальная функция для открытия модального окна редактирования
    async function editProject(projectIdentifier, projectType) {
        await readProjectsFile();

        let modalId, projectToEdit;
        const identifierValue = (projectType === 'gameApp') ? parseInt(projectIdentifier) : projectIdentifier; 

        if (projectType === 'gameApp') {
            projectToEdit = allUserData.gameApp.find(p => p.id === identifierValue);
            modalId = 'editGameAppModal';
        } else {
            projectToEdit = allUserData[projectType].find(p => p.id === identifierValue);
            modalId = `edit${projectType.charAt(0).toUpperCase() + projectType.slice(1)}Modal`;
        }
        
        if (projectToEdit) {
            if (projectType === 'gameApp') {
                document.getElementById('editGameAppOriginalId').value = projectToEdit.id;
                document.getElementById('editGameAppName').value = projectToEdit.name;
                document.getElementById('editGameAppPrice').value = projectToEdit.price;
                document.getElementById('editGameAppImage').value = projectToEdit.image;
                document.getElementById('editGameAppInstallURL').value = projectToEdit.installURL;
            } else if (projectType === 'search') {
                document.getElementById('editSearchOriginalString').value = projectToEdit.id;
                document.getElementById('editSearchName').value = projectToEdit.name;
                document.getElementById('editSearchUrl').value = projectToEdit.url;
                document.getElementById('editSearchData').value = projectToEdit.data;
            } else if (projectType === 'datapedia') {
                document.getElementById('editDatapediaOriginalString').value = projectToEdit.id;
                document.getElementById('editDatapediaName').value = projectToEdit.name;
                document.getElementById('editDatapediaImg').value = projectToEdit.img;
                document.getElementById('editDatapediaCode').value = projectToEdit.code;
            }
            document.getElementById(modalId).style.display = 'flex';
        } else {
            alert(`Project not found for editing.`);
        }
        document.getElementById('modal3').style.display = 'none';
    }


    // 7. Универсальная функция для сохранения изменений проекта
    async function saveProjectChanges(projectType) {
        let identifier, currentDataKey, modalId;

        switch (projectType) {
            case 'search':
                identifier = document.getElementById('editSearchOriginalString').value.trim();
                currentDataKey = 'search';
                modalId = 'editSearchModal';
                break;
            case 'datapedia':
                identifier = document.getElementById('editDatapediaOriginalString').value.trim();
                currentDataKey = 'datapedia';
                modalId = 'editDatapediaModal';
                break;
            case 'gameApp':
                identifier = parseInt(document.getElementById('editGameAppOriginalId').value.trim());
                currentDataKey = 'gameApp';
                modalId = 'editGameAppModal';
                break;
            default:
                return;
        }
        
        await readProjectsFile();

        const projectIndex = allUserData[currentDataKey].findIndex(p => p.id === identifier);


        if (projectIndex !== -1) {
            let projectToUpdate = allUserData[currentDataKey][projectIndex];
            
            if (projectType === 'gameApp') {
                const newName = document.getElementById('editGameAppName').value.trim();
                const newPrice = document.getElementById('editGameAppPrice').value.trim();
                const newImage = document.getElementById('editGameAppImage').value.trim();
                const newInstallURL = document.getElementById('editGameAppInstallURL').value.trim();

                if (!newName || !newPrice || !newImage || !newInstallURL) {
                    alert('All fields are required!');
                    return;
                }

                projectToUpdate.name = newName;
                projectToUpdate.price = parseFloat(newPrice);
                projectToUpdate.image = newImage;
                projectToUpdate.installURL = newInstallURL;
                
            } else if (projectType === 'search') {
                const newName = document.getElementById('editSearchName').value.trim();
                const newUrl = document.getElementById('editSearchUrl').value.trim();
                const newData = document.getElementById('editSearchData').value.trim();

                if (!newName || !newUrl || !newData) {
                    alert('All fields are required!');
                    return;
                }

                projectToUpdate.name = newName;
                projectToUpdate.url = newUrl;
                projectToUpdate.data = newData;
                projectToUpdate.id = `${newName}~${newUrl}~${newData}`;
                projectToUpdate.originalString = projectToUpdate.id;

            } else if (projectType === 'datapedia') {
                const newName = document.getElementById('editDatapediaName').value.trim();
                const newImg = document.getElementById('editDatapediaImg').value.trim();
                const newCode = document.getElementById('editDatapediaCode').value.trim();

                if (!newName || !newImg || !newCode) {
                    alert('All fields are required!');
                    return;
                }

                projectToUpdate.name = newName;
                projectToUpdate.img = newImg;
                projectToUpdate.code = newCode;
                projectToUpdate.id = `${newName}~${newImg}~${newCode}`;
                projectToUpdate.originalString = projectToUpdate.id;
            }
            
            allUserData[currentDataKey][projectIndex] = projectToUpdate;

            try {
                await writeProjectsFile();
                alert(`${projectType} project updated successfully!`);
                document.getElementById(modalId).style.display = 'none';
                showProjects(projectType);
            } catch (error) {
            }
        } else {
            alert(`Error: Project not found during save.`);
        }
    }


    // 4. ИНИЦИАЛИЗАЦИЯ
    (async function() {
        await readProjectsFile();

        updateUserInfo(); 
        const savedTheme = getCookie('theme') || 'dark';
        applyTheme(savedTheme);

        updateSettingsList(); 
        showSettingsSection('Overview');
        
        if (window.innerWidth <= 768) {
             document.getElementById('settingsNav').classList.remove('active');
        }
    })();
</script>
</body>
</html>