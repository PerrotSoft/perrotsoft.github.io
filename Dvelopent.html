<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="img/ico.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style1.css">
    <script src="js/sitefun.js" type="module"></script>
    <script src="js/user.js"></script> 
    <style>
    body {
        font-family: Arial, sans-serif;
        background: #f1f3f4;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh; /* ИЗМЕНЕНИЕ: Используйте min-height вместо height */
        /* Добавьте overflow-y: scroll; если хотите, чтобы полоса прокрутки всегда была видна,
           даже когда контента мало. Иначе она появится, когда контент превысит min-height. */
        overflow-y: auto; /* Добавлено для прокрутки основного body, если контент длиннее */
    }

    .account-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 600px;
        padding: 40px;
        box-sizing: border-box;
        text-align: center;
    }

    .avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #ccc;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: bold;
        color: white;
    }

    .username {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 6px;
    }

    .email {
        font-size: 16px;
        color: gray;
        margin-bottom: 20px;
    }

    hr {
        border: none;
        height: 1px;
        background-color: #e0e0e0;
        margin: 24px 0;
    }

    .button {
        display: block;
        width: 100%;
        padding: 14px;
        background: #1ae84e;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        margin-bottom: 16px;
    }

    .button:hover {
        background: #0cc00c;
    }

    .note {
        font-size: 14px;
        color: #666;
        margin-top: -10px;
        margin-bottom: 16px;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-sizing: border-box;
        text-align: left;
        max-height: 90vh; /* ИЗМЕНЕНИЕ: Ограничиваем максимальную высоту модального окна */
        overflow-y: auto; /* ИЗМЕНЕНИЕ: Добавляем прокрутку, если содержимое превышает max-height */
    }

    .modal input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    .modal-buttons {
        text-align: right;
    }

    .modal-buttons button {
        margin-left: 10px;
    }

    /* NEW: Styles for project items in the modal */
    .project-item {
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        background-color: #f9f9f9;
        position: relative; /* Для позиционирования кнопок */
    }

    .project-item h4 {
        margin-top: 0;
        margin-bottom: 5px;
        color: #333;
    }

    .project-item p {
        margin: 3px 0;
        font-size: 14px;
        color: #555;
    }

    .project-item .actions {
        margin-top: 10px;
        display: flex;
        gap: 5px;
        justify-content: flex-end; /* Выравнивание кнопок вправо */
    }

    .project-item button {
        padding: 6px 12px;
        font-size: 14px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: auto; 
        display: inline-block; 
    }

    .project-item button:hover {
        background-color: #0056b3;
    }

    .project-item button.delete-btn { /* Отдельный класс для кнопки удаления */
        background-color: #dc3545;
    }

    .project-item button.delete-btn:hover {
        background-color: #c82333;
    }

    .modal label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
        font-size: 14px;
    }

    /* NEW: Styles for project type filter */
    .project-filter {
        margin-bottom: 15px;
        text-align: center;
    }

    .project-filter button {
        padding: 8px 15px;
        margin: 0 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f0f0f0;
        cursor: pointer;
    }

    .project-filter button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }


    /* mcss: мобильная версия для accunt.html */
    @media (max-width: 768px) {
        body {
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            height: auto; /* Это уже хорошо для мобильной версии */
            padding: 0;
        }
        .account-panel {
            width: 98vw;
            max-width: 100%;
            padding: 16px;
            border-radius: 8px;
            margin: 10px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .avatar, .user-icn1 {
            width: 70px !important;
            height: 70px !important;
            font-size: 24px !important;
            margin-bottom: 10px !important;
        }
        .username, .name1 {
            font-size: 18px !important;
        }
        .email, .email1 {
            font-size: 14px !important;
        }
        .button {
            font-size: 16px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .modal-content {
            width: 98vw;
            max-width: 100%;
            padding: 14px;
            border-radius: 8px;
            max-height: 90vh; /* ИЗМЕНЕНИЕ: Также для мобильной версии */
            overflow-y: auto; /* ИЗМЕНЕНИЕ: Также для мобильной версии */
        }
        .modal input {
            font-size: 15px;
            padding: 8px;
            margin: 8px 0;
        }
        .modal-buttons button {
            font-size: 15px;
            padding: 7px 14px;
            margin-left: 6px;
        }
        .note {
            font-size: 12px;
            margin-bottom: 10px;
        }
        .menuContainer {
            flex-direction: column;
            gap: 6px;
            padding: 0 4px;
        }
        .appItem {
            flex-direction: row;
            align-items: center;
            padding: 7px 0;
        }
        .appItem img,
        .appItem .appIcon {
            width: 28px;
            height: 28px;
            margin-right: 8px;
        }
    }
</style>
</head>
<body>
    <div>
        <button class="toggleButton" onclick="toggleMenu()">☰</button>
        <div class="user-widget" onclick="toggleUserMenu()">
            <img class="user-icn" src="https://cdn-icons-png.flaticon.com/128/17807/17807725.png" alt="Иконка профиля">
            <div class="user-widget-info">
                <div class="name">User Name</div>
                <div class="email"></div>
                <div class="pcoin">Pcoin 0</div>
            </div>
        </div>
        <div class="user-menu" id="userMenu" style="display: none;">
            <button onclick="window.location.href='accunt'">Setings</button>
            <button onclick="window.location.href='accunt'">top up balance Pcoin</button>
            <button onclick="window.location.href='riegist'">register or login</button>
        </div>
        <div class="menuContainer" id="menuContainer">
            <div class="appItem">
                <form action="results.html" method="get">
                    <input type="text" name="query" placeholder="Enter your query" style="width: 70px ;height: 10px;" required>
                    <button type="submit" style="height: 40px;width: 80px;">Search</button>
                </form>
            </div>
            <div class="appItem" onclick="openApp('PerrotSoft-Play')">
                <i class="fab fa-google-play appIcon"></i>
                <span>Play</span>
            </div>
            <div class="appItem" onclick="openApp('https://perrotsoft.github.io/')">
                <img src="img/Home.png" alt="png">
                <span>Home</span>
            </div>
            <div class="appItem" onclick="openApp('Install_PerrotOS')">
                <img src="img/ico1.png" alt="png">
                <span>install OS</span>
            </div>
            <div class="appItem" onclick="openApp('datapedia')">
                <img src="img/datapedia icon1.png" alt="png">
                <span>dataPedia</span>
            </div>
        <div class="appItem" onclick="openApp('https://wavychatapp.github.io/')">
            <img src="https://wavychatapp.github.io/WavyChatApp.ico" width="30px" height="30px" alt="png">
            <span>WavyChatApp</span>
        </div>
        <div class="appItem" onclick="openApp('https://wavychatapp.github.io/')">
            <img src="https://wavychatapp.github.io/WavyChatApp.ico" width="30px" height="30px" alt="png">
            <span>WavyChatApp</span>
        </div>
            <div class="appItem" onclick="openApp('accunt')">
                <img src="img/as.png" alt="png">
                <span>Account settings.</span>
            </div>
        </div>
        <div class="account-panel">
            <h2>Developent panel</h2>
            <button class="button" onclick="document.getElementById('modal').style.display='flex'">add Search</button>
            <button class="button" onclick="document.getElementById('modal1').style.display='flex'">Add article to datapedia</button>
            <button class="button" onclick="document.getElementById('modal2').style.display='flex'">add a game or app to Parrot Play</button>
            <button class="button" onclick="showProjects('all')">View/Manage My Projects</button>
            <hr>
            <div class="appItem" onclick="openApp('ParrotSoftIDE.html')">
                <img src="img/ParrotIDE_mini.png" alt="png">
                <span>ParrotSoftIDE</span>
            </div>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content">
                <h3 id="modal-title">Add Search</h3>
                <div id="modal-fields">
                    <input type="text" name="searchName" placeholder="Search Name" required>
                    <input type="text" name="searchUrl" placeholder="Search URL" required>
                    <input type="text" name="searchdata" placeholder="Search data" required>
                </div>
                <div class="modal-buttons">
                    <button onclick="document.getElementById('modal').style.display='none'">Cancel</button>
                    <button onclick="confirmChanges('search')">Confirm</button>
                </div>
            </div>
        </div>

        <div id="modal1" class="modal">
            <div class="modal-content">
                <h3 id="modal-title">creating an article</h3>
                <div id="modal1-fields">
                    <input type="text" name="Name" placeholder="Name" required>
                    <input type="text" name="img" placeholder="img" required>
                    <input type="text" name="code" placeholder="code" required>
                </div>
                <div class="modal-buttons">
                    <button onclick="document.getElementById('modal1').style.display='none'">Cancel</button>
                    <button onclick="confirmChanges('datapedia')">Confirm</button>
                </div>
            </div>
        </div>

        <div id="modal2" class="modal">
            <div class="modal-content">
                <h3 id="modal-title">Add Game/App</h3>
                <div id="modal2-fields">
                    <input type="text" name="Name" placeholder="Name" required>
                    <input type="text" name="price" placeholder="price" required>
                    <input type="text" name="image" placeholder="image URL" required>
                    <input type="text" name="installURL" placeholder="Install URL" required> </div>
                <div class="modal-buttons">
                    <button onclick="document.getElementById('modal2').style.display='none'">Cancel</button>
                    <button onclick="confirmChanges('gameApp')">Confirm</button>
                </div>
            </div>
        </div>

        <div id="modal3" class="modal">
            <div class="modal-content">
                <h3>My Projects</h3>
                <div class="project-filter">
                    <button id="filter-all" class="active" onclick="showProjects('all')">All</button>
                    <button id="filter-search" onclick="showProjects('search')">Search</button>
                    <button id="filter-datapedia" onclick="showProjects('datapedia')">Datapedia</button>
                    <button id="filter-gameApp" onclick="showProjects('gameApp')">Games/Apps</button>
                </div>
                <div id="projects-list">
                    <p>No projects found. Add some projects using the buttons above!</p>
                </div>
                <div class="modal-buttons">
                    <button onclick="document.getElementById('modal3').style.display='none'">Close</button>
                </div>
            </div>
        </div>

        <div id="editSearchModal" class="modal">
            <div class="modal-content">
                <h3>Edit Search Project</h3>
                <div id="editSearchFields">
                    <input type="hidden" id="editSearchOriginalString"> 
                    <label for="editSearchName">Search Name:</label>
                    <input type="text" id="editSearchName" placeholder="Search Name" required>
                    <label for="editSearchUrl">Search URL:</label>
                    <input type="text" id="editSearchUrl" placeholder="Search URL" required>
                    <label for="editSearchData">Search Data:</label>
                    <input type="text" id="editSearchData" placeholder="Search data" required>
                </div>
                <div class="modal-buttons">
                    <button onclick="document.getElementById('editSearchModal').style.display='none'">Cancel</button>
                    <button onclick="saveProjectChanges('search')">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="editDatapediaModal" class="modal">
            <div class="modal-content">
                <h3>Edit Datapedia Article</h3>
                <div id="editDatapediaFields">
                    <input type="hidden" id="editDatapediaOriginalString"> 
                    <label for="editDatapediaName">Article Name:</label>
                    <input type="text" id="editDatapediaName" placeholder="Name" required>
                    <label for="editDatapediaImg">Image URL:</label>
                    <input type="text" id="editDatapediaImg" placeholder="img" required>
                    <label for="editDatapediaCode">Code:</label>
                    <input type="text" id="editDatapediaCode" placeholder="code" required>
                </div>
                <div class="modal-buttons">
                    <button onclick="document.getElementById('editDatapediaModal').style.display='none'">Cancel</button>
                    <button onclick="saveProjectChanges('datapedia')">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="editGameAppModal" class="modal">
            <div class="modal-content">
                <h3>Edit Game/App Project</h3>
                <div id="editGameAppFields">
                    <input type="hidden" id="editGameAppOriginalId"> <label for="editGameAppName">Name:</label>
                    <input type="text" id="editGameAppName" placeholder="Name" required>
                    <label for="editGameAppPrice">Price:</label>
                    <input type="text" id="editGameAppPrice" placeholder="price" required>
                    <label for="editGameAppImage">Image URL:</label>
                    <input type="text" id="editGameAppImage" placeholder="image URL" required>
                    <label for="editGameAppInstallURL">Install URL:</label>
                    <input type="text" id="editGameAppInstallURL" placeholder="Install URL" required>
                    </div>
                <div class="modal-buttons">
                    <button onclick="document.getElementById('editGameAppModal').style.display='none'">Cancel</button>
                    <button onclick="saveProjectChanges('gameApp')">Save Changes</button>
                </div>
            </div>
        </div>


        <script>
            // Глобальные переменные
            let userid = 0;
            let allUserData = {
                search: "",    // Соответствует 'L' + userid
                datapedia: "", // Соответствует 'K' + userid
                gameApp: ""    // Соответствует 'J' + userid
            };

            // Асинхронная функция для получения данных при загрузке
            (async function() {
                try {
                    userid = await userID(getCookie('name'));
                    console.log("Fetched UserID:", userid);

                    // Загружаем все типы данных
                    allUserData.search = await readCell('L' + userid) || "";
                    console.log("Fetched Search Data (L):", allUserData.search);

                    allUserData.datapedia = await readCell('K' + userid) || "";
                    console.log("Fetched Datapedia Data (K):", allUserData.datapedia);

                    allUserData.gameApp = await readCell('J' + userid) || "";
                    console.log("Fetched Game/App Data (J):", allUserData.gameApp);

                } catch (error) {
                    console.error("Error fetching user data:", error);
                }
            })();

            // Универсальная функция для добавления проекта
            async function confirmChanges(projectType) {
                let modalId, fieldsSelector, targetColumn, currentDataKey, newEntryParts = [];

                switch (projectType) {
                    case 'search':
                        modalId = 'modal';
                        fieldsSelector = '#modal-fields input';
                        targetColumn = 'L' + userid;
                        currentDataKey = 'search';
                        break;
                    case 'datapedia':
                        modalId = 'modal1';
                        fieldsSelector = '#modal1-fields input';
                        targetColumn = 'K' + userid;
                        currentDataKey = 'datapedia';
                        break;
                    case 'gameApp':
                        modalId = 'modal2';
                        fieldsSelector = '#modal2-fields input';
                        targetColumn = 'J' + userid;
                        currentDataKey = 'gameApp';
                        break;
                    default:
                        console.error("Unknown project type:", projectType);
                        return;
                }

                const modal = document.getElementById(modalId);
                const fields = document.querySelectorAll(fieldsSelector);
                
                // Проверяем, что все поля заполнены
                let allFieldsFilled = true;
                fields.forEach(field => {
                    if (field.value.trim() === '') {
                        allFieldsFilled = false;
                    }
                    newEntryParts.push(field.value.trim());
                });

                if (!allFieldsFilled) {
                    alert('All fields are required!');
                    return;
                }

                let newEntryString;

                if (projectType === 'gameApp') {
                    // Для Game/App: id, name, price, image, owned(false), installed(false), installURL
                    const newGameAppId = Date.now(); // Генерируем уникальный ID
                    const name = newEntryParts[0];
                    const price = newEntryParts[1];
                    const image = newEntryParts[2];
                    const installURL = newEntryParts[3];
                    const owned = 'false';    // Автоматически false
                    const installed = 'false'; // Автоматически false
                    newEntryString = `${newGameAppId}~${name}~${price}~${image}~${owned}~${installed}~${installURL}`;
                } else {
                    // Для Search и Datapedia: без ID
                    newEntryString = newEntryParts.join('~'); 
                }
                
                let currentData = allUserData[currentDataKey] || "";

                if (currentData && currentData.trim() !== "") {
                    currentData += "|"; 
                }
                let updatedData = currentData + newEntryString;

                try {
                    await writeCell(targetColumn, updatedData);
                    console.log(`Changes confirmed (${projectType}):`, updatedData);
                    allUserData[currentDataKey] = updatedData; // Обновляем глобальную переменную
                    modal.style.display = 'none';
                    alert('Project added successfully!');
                    fields.forEach(field => field.value = ''); // Очистка полей
                } catch (error) {
                    console.error(`Error saving ${projectType} project:`, error);
                    alert(`Failed to save ${projectType} project. Please try again.`);
                }
            }
            
            // Адаптируем showProjects для отображения всех типов и фильтрации
            async function showProjects(filterType = 'all') {
                const projectsListDiv = document.getElementById('projects-list');
                projectsListDiv.innerHTML = ''; // Очищаем список перед заполнением

                // Снимаем активность со всех кнопок фильтра и добавляем активный класс к выбранной
                document.querySelectorAll('.project-filter button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`filter-${filterType}`).classList.add('active');

                console.log(`Starting showProjects() with filter: ${filterType}`);
                console.log("Current allUserData for display:", allUserData);

                let allParsedProjects = [];

                // Парсим Search проекты (L-колонка: Name~Url~data)
                if (allUserData.search) {
                    allUserData.search.split('|').filter(s => s.trim() !== '').forEach((projectString, index) => {
                        const parts = projectString.split('~');
                        if (parts.length >= 3) { // Ожидаем 3 части: Name, Url, data
                            allParsedProjects.push({
                                // Для Search используем originalString как идентификатор для удаления/редактирования
                                id: projectString, 
                                type: 'search',
                                name: parts[0].trim(),
                                url: parts[1].trim(),
                                data: parts[2].trim(),
                                originalString: projectString // Сохраняем оригинальную строку
                            });
                        }
                    });
                }

                // Парсим Datapedia проекты (K-колонка: Name~img~code)
                if (allUserData.datapedia) {
                    allUserData.datapedia.split('|').filter(s => s.trim() !== '').forEach((projectString, index) => {
                        const parts = projectString.split('~');
                        if (parts.length >= 3) { // Ожидаем 3 части: Name, img, code
                            allParsedProjects.push({
                                // Для Datapedia используем originalString как идентификатор
                                id: projectString,
                                type: 'datapedia',
                                name: parts[0].trim(),
                                img: parts[1].trim(),
                                code: parts[2].trim(),
                                originalString: projectString
                            });
                        }
                    });
                }

                // Парсим Game/App проекты (J-колонка: id~name~price~image~owned~installed~installURL)
                if (allUserData.gameApp) {
                    allUserData.gameApp.split('|').filter(s => s.trim() !== '').forEach((projectString) => {
                        const parts = projectString.split('~');
                        // Ожидаем 7 частей для нового формата Game/App
                        if (parts.length >= 7) { 
                            allParsedProjects.push({
                                id: parseInt(parts[0]), // ID
                                type: 'gameApp',
                                name: parts[1].trim(),
                                price: parseFloat(parts[2]),
                                image: parts[3].trim(), 
                                owned: parts[4] === "true", // owned
                                installed: parts[5] === "true", // installed
                                installURL: parts[6].trim(), // installURL
                                originalString: projectString // Сохраняем оригинальную строку
                            });
                        } else if (parts.length >= 4) { // Обработка старых форматов (без ID, owned, installed, installURL)
                            // Если старый формат, где был Name~price~image~Url
                            // ID будет отсутствовать, поэтому используем originalString как fall-back ID для редактирования/удаления
                            allParsedProjects.push({
                                id: projectString, // Временный ID для старых записей
                                type: 'gameApp',
                                name: parts[0].trim(),
                                price: parseFloat(parts[1]),
                                image: parts[2].trim(),
                                installURL: parts[3].trim(), // Предполагаем, что старый "Url" это "installURL"
                                owned: false, // По умолчанию для старых
                                installed: false, // По умолчанию для старых
                                originalString: projectString
                            });
                        }
                    });
                }

                console.log("All parsed projects:", allParsedProjects);

                let filteredProjects = allParsedProjects;
                if (filterType !== 'all') {
                    filteredProjects = allParsedProjects.filter(p => p.type === filterType);
                }

                if (filteredProjects.length === 0) {
                    projectsListDiv.innerHTML = `<p>No ${filterType !== 'all' ? filterType : ''} projects found.</p>`;
                } else {
                    filteredProjects.forEach(project => {
                        const projectDiv = document.createElement('div');
                        projectDiv.classList.add('project-item');

                        let detailsHtml = '';
                        let deleteIdentifier; // Идентификатор для удаления
                        let editIdentifier;   // Идентификатор для редактирования

                        if (project.type === 'gameApp' && typeof project.id === 'number') {
                            // Для Game/App используем ID для удаления/редактирования
                            deleteIdentifier = project.id;
                            editIdentifier = project.id;
                        } else {
                            // Для Search и Datapedia используем originalString
                            deleteIdentifier = project.originalString;
                            editIdentifier = project.originalString;
                        }

                        switch (project.type) {
                            case 'search':
                                detailsHtml = `
                                    <h4>${project.name} <span style="font-size: 0.8em; color: #888;">(Search)</span></h4>
                                    <p>URL: <a href="${project.url}" target="_blank">${project.url}</a></p>
                                    <p>Data: ${project.data}</p>
                                `;
                                break;
                            case 'datapedia':
                                detailsHtml = `
                                    <h4>${project.name} <span style="font-size: 0.8em; color: #888;">(Datapedia Article)</span></h4>
                                    <p>Image: <a href="${project.img}" target="_blank">${project.img}</a></p>
                                    <p>Code: ${project.code}</p>
                                `;
                                break;
                            case 'gameApp':
                                detailsHtml = `
                                    <h4>${project.name} <span style="font-size: 0.8em; color: #888;">(Game/App)</span></h4>
                                    <p>ID: ${project.id}</p>
                                    <p>Price: ${project.price}</p>
                                    <p>Image: <a href="${project.image}" target="_blank">${project.image}</a></p>
                                    <p>Install URL: <a href="${project.installURL}" target="_blank">${project.installURL}</a></p>
                                    <p>Status: Owned: ${project.owned ? 'Yes' : 'No'}, Installed: ${project.installed ? 'Yes' : 'No'}</p>
                                `;
                                break;
                        }

                        // Важно: передаем идентификатор в виде строки, экранируя кавычки
                        projectDiv.innerHTML = `
                            ${detailsHtml}
                            <div class="actions">
                                <button onclick="editProject('${String(editIdentifier).replace(/'/g, "\\'")}', '${project.type}')">Edit</button>
                                <button class="delete-btn" onclick="deleteProject('${String(deleteIdentifier).replace(/'/g, "\\'")}', '${project.type}')">Delete</button>
                            </div>
                        `;
                        projectsListDiv.appendChild(projectDiv);
                    });
                }
                document.getElementById('modal3').style.display = 'flex';
            }


            // Универсальная функция для удаления проекта
            // Теперь projectIdentifier может быть ID (для Game/App) или полной строкой (для Search/Datapedia)
            async function deleteProject(projectIdentifier, projectType) {
                if (!confirm(`Are you sure you want to delete this ${projectType} project?`)) {
                    return;
                }

                console.log(`Attempting to delete ${projectType} project with identifier:`, projectIdentifier);
                
                let currentDataKey, targetColumn;
                switch (projectType) {
                    case 'search':
                        currentDataKey = 'search';
                        targetColumn = 'L' + userid;
                        break;
                    case 'datapedia':
                        currentDataKey = 'datapedia';
                        targetColumn = 'K' + userid;
                        break;
                    case 'gameApp':
                        currentDataKey = 'gameApp';
                        targetColumn = 'J' + userid;
                        break;
                    default:
                        console.error("Unknown project type for deletion:", projectType);
                        return;
                }

                let projectData = allUserData[currentDataKey] || "";
                if (!projectData || projectData.trim() === "") {
                    console.error("No project data of this type to delete from.");
                    alert("No project data of this type to delete from.");
                    return;
                }

                const projects = projectData.split('|').filter(s => s.trim() !== '');
                const updatedProjects = [];

                let found = false;
                projects.forEach(projectString => {
                    if (projectType === 'gameApp') {
                        // Для Game/App сравниваем по ID
                        const parts = projectString.split('~');
                        if (parts.length > 0 && parseInt(parts[0]) === parseInt(projectIdentifier)) {
                            found = true;
                            console.log(`Deleting Game/App project by ID: ${projectIdentifier}`);
                        } else {
                            updatedProjects.push(projectString);
                        }
                    } else {
                        // Для Search/Datapedia сравниваем полные строки
                        if (projectString === projectIdentifier) { 
                            found = true;
                            console.log(`Deleting ${projectType} project: ${projectString}`);
                        } else {
                            updatedProjects.push(projectString);
                        }
                    }
                });

                if (found) {
                    const newProjectData = updatedProjects.join('|');
                    try {
                        await writeCell(targetColumn, newProjectData);
                        allUserData[currentDataKey] = newProjectData; // Обновляем глобальную переменную
                        alert(`${projectType} project deleted successfully!`);
                        showProjects(projectType); // Обновляем список проектов после удаления
                    } catch (error) {
                        console.error(`Error deleting ${projectType} project:`, error);
                        alert(`Failed to delete ${projectType} project. Please try again.`);
                    }
                } else {
                    alert(`Project not found for deletion.`);
                    console.warn(`Project with identifier "${projectIdentifier}" (Type: ${projectType}) not found for deletion.`);
                }
            }

            // Универсальная функция для открытия модального окна редактирования
            // projectIdentifier может быть ID (для Game/App) или полной строкой (для Search/Datapedia)
            async function editProject(projectIdentifier, projectType) {
                console.log(`Attempting to edit ${projectType} project with identifier:`, projectIdentifier);

                let currentDataKey, modalId;
                switch (projectType) {
                    case 'search':
                        currentDataKey = 'search';
                        modalId = 'editSearchModal';
                        break;
                    case 'datapedia':
                        currentDataKey = 'datapedia';
                        modalId = 'editDatapediaModal';
                        break;
                    case 'gameApp':
                        currentDataKey = 'gameApp';
                        modalId = 'editGameAppModal';
                        break;
                    default:
                        console.error("Unknown project type for editing:", projectType);
                        return;
                }

                let projectData = allUserData[currentDataKey] || "";
                if (!projectData || projectData.trim() === "") {
                    alert("No project data of this type to edit.");
                    return;
                }

                const projects = projectData.split('|').filter(s => s.trim() !== '');
                let projectToEditParts = null;
                let originalProjectStringFound = ''; // Для хранения оригинальной строки

                for (const projectString of projects) {
                    if (projectType === 'gameApp') {
                        const parts = projectString.split('~');
                        if (parts.length > 0 && parseInt(parts[0]) === parseInt(projectIdentifier)) {
                            projectToEditParts = parts;
                            originalProjectStringFound = projectString;
                            break;
                        }
                    } else {
                        if (projectString === projectIdentifier) {
                            projectToEditParts = projectString.split('~');
                            originalProjectStringFound = projectString;
                            break;
                        }
                    }
                }

                if (projectToEditParts) {
                    if (projectType === 'gameApp') {
                        document.getElementById('editGameAppOriginalId').value = projectIdentifier; // Сохраняем ID
                        document.getElementById('editGameAppName').value = projectToEditParts[1] || '';
                        document.getElementById('editGameAppPrice').value = projectToEditParts[2] || '';
                        document.getElementById('editGameAppImage').value = projectToEditParts[3] || '';
                        document.getElementById('editGameAppInstallURL').value = projectToEditParts[6] || '';
                        // owned и installed не редактируются из этой панели
                    } else {
                        // Для Search и Datapedia используем originalString
                        document.getElementById(`${modalId.replace('Modal', '')}OriginalString`).value = originalProjectStringFound;
                        switch (projectType) {
                            case 'search':
                                document.getElementById('editSearchName').value = projectToEditParts[0] || '';
                                document.getElementById('editSearchUrl').value = projectToEditParts[1] || '';
                                document.getElementById('editSearchData').value = projectToEditParts[2] || '';
                                break;
                            case 'datapedia':
                                document.getElementById('editDatapediaName').value = projectToEditParts[0] || '';
                                document.getElementById('editDatapediaImg').value = projectToEditParts[1] || '';
                                document.getElementById('editDatapediaCode').value = projectToEditParts[2] || '';
                                break;
                        }
                    }
                    document.getElementById(modalId).style.display = 'flex';
                } else {
                    alert(`Project not found for editing.`);
                    console.warn(`Project with identifier "${projectIdentifier}" (Type: ${projectType}) not found for editing.`);
                }
            }


            // Универсальная функция для сохранения изменений проекта
            async function saveProjectChanges(projectType) {
                let identifier, newValues = [], currentDataKey, targetColumn, modalId;

                switch (projectType) {
                    case 'search':
                        identifier = document.getElementById('editSearchOriginalString').value.trim(); // Это originalString
                        newValues = [
                            document.getElementById('editSearchName').value.trim(),
                            document.getElementById('editSearchUrl').value.trim(),
                            document.getElementById('editSearchData').value.trim()
                        ];
                        currentDataKey = 'search';
                        targetColumn = 'L' + userid;
                        modalId = 'editSearchModal';
                        break;
                    case 'datapedia':
                        identifier = document.getElementById('editDatapediaOriginalString').value.trim(); // Это originalString
                        newValues = [
                            document.getElementById('editDatapediaName').value.trim(),
                            document.getElementById('editDatapediaImg').value.trim(),
                            document.getElementById('editDatapediaCode').value.trim()
                        ];
                        currentDataKey = 'datapedia';
                        targetColumn = 'K' + userid;
                        modalId = 'editDatapediaModal';
                        break;
                    case 'gameApp':
                        identifier = document.getElementById('editGameAppOriginalId').value.trim(); // Это ID проекта
                        newValues = [
                            document.getElementById('editGameAppName').value.trim(),
                            document.getElementById('editGameAppPrice').value.trim(),
                            document.getElementById('editGameAppImage').value.trim(),
                            document.getElementById('editGameAppInstallURL').value.trim()
                        ];
                        currentDataKey = 'gameApp';
                        targetColumn = 'J' + userid;
                        modalId = 'editGameAppModal';
                        break;
                    default:
                        console.error("Unknown project type for saving changes:", projectType);
                        return;
                }

                // Проверка, что все поля заполнены
                if (newValues.some(val => val === '')) {
                    alert('All fields are required!');
                    return;
                }

                console.log(`Attempting to save changes for ${projectType} project (Identifier):`, identifier);
                
                let projectData = allUserData[currentDataKey] || "";
                const projects = projectData.split('|').filter(s => s.trim() !== '');
                const updatedProjects = [];

                let found = false;
                for (const projectString of projects) {
                    if (projectType === 'gameApp') {
                        const parts = projectString.split('~');
                        if (parts.length > 0 && parseInt(parts[0]) === parseInt(identifier)) {
                            // Сохраняем старые owned и installed значения
                            const owned = parts[4] || 'false'; 
                            const installed = parts[5] || 'false';
                            const newGameAppString = `${identifier}~${newValues[0]}~${newValues[1]}~${newValues[2]}~${owned}~${installed}~${newValues[3]}`; // newValues[3] это installURL
                            updatedProjects.push(newGameAppString);
                            found = true;
                        } else {
                            updatedProjects.push(projectString);
                        }
                    } else {
                        // Для Search и Datapedia сравниваем по полной строке
                        if (projectString === identifier) {
                            const newString = newValues.join('~');
                            updatedProjects.push(newString);
                            found = true;
                        } else {
                            updatedProjects.push(projectString);
                        }
                    }
                }

                if (found) {
                    const newProjectData = updatedProjects.join('|');
                    try {
                        await writeCell(targetColumn, newProjectData);
                        allUserData[currentDataKey] = newProjectData; // Обновляем глобальную переменную
                        alert(`${projectType} project updated successfully!`);
                        document.getElementById(modalId).style.display = 'none';
                        showProjects(projectType); // Обновляем список проектов
                    } catch (error) {
                        console.error(`Error saving ${projectType} project changes:`, error);
                        alert(`Failed to save ${projectType} project changes. Please try again.`);
                    }
                } else {
                    alert(`Error: Project not found during save.`);
                    console.error(`Error: Project with identifier "${identifier}" (Type: ${projectType}) not found during save.`);
                }
            }

            // Функции для управления боковым меню и пользовательским виджетом (оставляем как есть)
            function toggleMenu() {
                const menu = document.getElementById('menuContainer');
                menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
            }

            function openApp(url) {
                if (url.startsWith('http')) {
                    window.open(url, '_blank');
                } else {
                    window.location.href = url;
                }
            }

            function toggleUserMenu() {
                const userMenu = document.getElementById('userMenu');
                userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
            }

            // Дополнительно: Добавим обработчик для закрытия меню по клику вне его
            document.addEventListener('click', function(event) {
                const userMenu = document.getElementById('userMenu');
                const userWidget = document.querySelector('.user-widget');
                const toggleButton = document.querySelector('.toggleButton');
                const menuContainer = document.getElementById('menuContainer');

                // Закрытие userMenu
                if (userMenu && userWidget && !userWidget.contains(event.target) && !userMenu.contains(event.target)) {
                    userMenu.style.display = 'none';
                }

                // Закрытие menuContainer
                if (menuContainer && toggleButton && !toggleButton.contains(event.target) && !menuContainer.contains(event.target)) {
                    menuContainer.style.display = 'none';
                }
            });

        </script>
    </div>
</body>
</html>