<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDrive â€” Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¸ÑĞº</title>
    <link rel="icon" href="img/ico.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style1.css">
    <script src="js/sitefun.js" type="module"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style1.css">

<style>
body { margin:0; font-family:'Roboto',sans-serif; background:#f1f3f4; color:#202124; transition: background 0.3s, color 0.3s;/* ĞĞĞ’ĞĞ¯ Ğ¡Ğ¢Ğ ĞĞšĞ: Ğ£Ğ»ÑƒÑ‡ÑˆĞ°ĞµÑ‚ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ½Ğ° ÑĞµĞ½ÑĞ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ²Ğ²Ğ¾Ğ´ */
    touch-action: manipulation; }
body.dark { background:#202124; color:#e8eaed; }
header { background:#1a73e8; color:white; padding:12px 24px; display:flex; justify-content:space-between; align-items:center; border-bottom-left-radius:12px; border-bottom-right-radius:12px; position: fixed; width: 100%; top: 0; z-index: 900; box-sizing: border-box; }
#user { font-size:14px; opacity:0.9; }
.toolbar { display:flex; gap:16px; padding:12px 24px; background:white; border-bottom:1px solid #e0e0e0; align-items:center; position: sticky; top: 60px; z-index: 500; } /* Adjusted top for fixed header */
.toolbar.dark { background:#303134; border-color:#5f6368; }

/* New Button Style (Google Drive like) */
#btn-new {
    background:#fff;
    color:#1a73e8;
    border:1px solid #dadce0;
    padding:10px 24px;
    border-radius:16px;
    font-weight:500;
    box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
    display:flex;
    align-items:center;
    gap:8px;
    transition: background-color 0.2s, box-shadow 0.2s;
}
button{
    color: #202124;
}
#btn-new:hover {
    background:#f8f9fa;
    box-shadow: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
}
#btn-new .plus-icon {
    font-size: 24px;
    line-height: 1;
}
.toolbar.dark #btn-new {
    background: #3c4043;
    color: #8ab4f8;
    border-color: #5f6368;
    box-shadow: none;
}
.toolbar.dark #btn-new:hover {
    background: #5f6368;
    box-shadow: none;
}

/* Other Buttons in toolbar */
button { background:#f8f9fa; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; transition:.2s; }
button:hover { background:#e8eaed; }
button.dark { background:#3c4043; color:#e8eaed; }
button.dark:hover { background:#5f6368; }

#files { padding:16px; }
table { width:100%; border-collapse:collapse; border-radius:12px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
th,td { padding:12px; text-align:left; }
th { background:#f1f3f4; }
th.dark { background:#303134; }
tr { transition: background 0.2s; cursor:pointer; }
tr:hover { background:#e8eaed; }
tr.dark:hover { background:#5f6368; }
.path { margin:12px 24px; color:#5f6368; }
.path.dark { color:#b8bbbe; }

/* Checkbox column */
td.checkbox-col { width:32px; text-align:center; }
input[type=checkbox] { transform:scale(1.2); }

/* Modal styles (File and New) */
#file-modal, #new-modal, #editor-modal { 
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center; 
    z-index:1000; 
}
#file-modal .content, #new-modal .content, #editor-modal .content { 
    background:white; 
    max-width:400px; 
    border-radius:12px; 
    padding:24px; 
    position:relative; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    max-width: 900px; 
}
#file-modal.dark .content, #new-modal.dark .content, #editor-modal.dark .content { 
    background:#303134; 
    color:#e8eaed; 
}
#file-modal .close, #new-modal .close, #editor-modal .close { 
    position:absolute; 
    top:12px; 
    right:16px; 
    cursor:pointer; 
    font-weight:bold; 
    font-size:18px; 
    color:#5f6368;
}
#new-modal h3, #editor-modal h3 { margin-top:0; font-weight:400; font-size: 1.5rem;}
#new-modal input[type="text"] {
    width: 100%;
    padding: 10px;
    margin: 10px 0 20px 0;
    border: 1px solid #dadce0;
    border-radius: 4px;
    box-sizing: border-box;
    background: #f1f3f4;
    color: #202124;
}
#new-modal.dark input[type="text"] {
    background: #3c4043;
    border-color: #5f6368;
    color: #e8eaed;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}
.modal-actions button {
    font-weight: 500;
}

#btn-modal-create, #btn-editor-save {
    background: #1a73e8;
    color: white;
}
#btn-modal-create:hover, #btn-editor-save:hover {
    background: #1565c0;
}
.dark #btn-modal-create, .dark #btn-editor-save {
    background: #8ab4f8;
    color: #202124;
}
.dark #btn-modal-create:hover, .dark #btn-editor-save:hover {
    background: #a6c5fa;
}

/* File Modal Specifics (Ğ“Ğ¸Ğ±ĞºĞ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°) */
#file-modal .content { 
    max-width: 90vw; 
    max-height: 90vh; 
    width: auto; 
    height: auto; 
    display: flex;
    flex-direction: column;
}
#modal-body {
    overflow-y: auto; 
    flex-grow: 1; 
}
#modal-actions-bar { display: flex; justify-content: flex-end; margin-bottom: 12px; flex-shrink: 0; }
#btn-edit { background: none; color: #1a73e8; border: 1px solid #dadce0; padding: 6px 10px; }
#btn-edit:hover { background: #e8eaed; }
#file-modal.dark #btn-edit { color: #8ab4f8; border-color: #5f6368; }
#file-modal.dark #btn-edit:hover { background: #5f6368; }
#modal-body pre { white-space: pre-wrap; word-break: break-word; }
#markdown-raw-view { margin-top: 20px; padding-top: 10px; border-top: 1px solid #e0e0e0; font-size: 0.8rem; }
#markdown-raw-view pre { background: #f8f9fa; padding: 10px; border-radius: 4px; }
#file-modal.dark #markdown-raw-view pre { background: #3c4043; }

/* Image Viewer (Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ñ‹ Ğ¶ĞµÑÑ‚ĞºĞ¸Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ) */
#modal-image {
    max-width: 100%; 
    max-height: 100%; 
    width: auto;
    height: auto;
    display: block;
    margin: 10px auto; 
    border: 1px solid #ccc; 
    padding: 10px;
    box-sizing: border-box;
    object-fit: contain; 
}

/* Editor Modal Specifics */
#editor-modal .content { max-width: 800px; width: 90%; max-height: 90%; }
#editor-modal textarea {
    width: 100%;
    height: 60vh;
    min-height: 300px;
    box-sizing: border-box;
    padding: 10px;
    border: 1px solid #dadce0;
    border-radius: 4px;
    margin-bottom: 10px;
    font-family: monospace;
    font-size: 14px;
    resize: none;
}
#editor-modal.dark textarea {
    background: #3c4043;
    border-color: #5f6368;
    color: #e8eaed;
}

/* New Menu Container */
#new-menu {
    display: none;
    position: absolute;
    top: 55px; /* Adjust based on toolbar height */
    left: 24px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 100;
    padding: 8px 0;
    min-width: 250px;
}
#new-menu.dark {
    background: #303134;
}
#new-menu button {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 8px 8px;
    border-radius: 8px;
    box-shadow: none;
    text-align: left;
    background: none;
}
#new-menu button:hover {
    background: #e8eaed;
}
#new-menu.dark button:hover {
    background: #5f6368;
}
#new-menu .icon {
    margin-right: 12px;
    font-size: 18px;
    width: 24px;
    text-align: center;
}
@media (max-width: 768px) {
    /* 1. ĞĞ±Ñ‰ĞµĞµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ */
    /* Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ header (50px) + toolbar (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ 50px) + Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ */
    body {
        padding-top: 108px; 
    }
    
    /* 2. Header (Ğ¨Ğ°Ğ¿ĞºĞ°) */
    header {
        padding: 0 16px;
        height: 50px;
    }
    header > div {
        margin-left: 0 !important; 
    }
    
    /* 3. Toolbar (ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²) */
    .toolbar {
        padding: 8px 16px;
        gap: 8px;
        overflow-x: auto; /* Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ° Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº */
        white-space: nowrap; 
        justify-content: flex-start;
        top: 50px; /* Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾Ğ´ header */
        height: 50px; /* Ğ¤Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ²Ñ‹ÑĞ¾Ñ‚Ğ° */
        box-sizing: border-box;
    }
    
    /* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ */
    .toolbar button:not(#btn-new) {
        padding: 8px 12px; 
    }
    .toolbar button:not(#btn-new) > :not(.plus-icon, svg, img, [class*="-icon"]) {
         display: none; 
    }
    
    /* ĞšĞ½Ğ¾Ğ¿ĞºĞ° 'New': Ğ´ĞµĞ»Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾Ğ¹ */
    #btn-new {
        padding: 8px 12px; 
        min-width: 40px; 
        font-size: 0; /* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ */
        order: -1; /* Ğ¡Ñ‚Ğ°Ğ²Ğ¸Ğ¼ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ğ² Ñ€ÑĞ´Ñƒ */
    }
    #btn-new .plus-icon {
        font-size: 18px; 
        margin-right: 0;
    }
    
    /* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ€Ğ°ÑÑ‚ÑĞ³Ğ¸Ğ²Ğ°ÑÑ‰Ğ¸Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ */
    .toolbar > div[style*="flex-grow"] {
        display: none; 
    }
    
    /* 4. ĞŸÑƒÑ‚ÑŒ Ğ¸ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² */
    .path, #files {
        padding-left: 16px;
        padding-right: 16px;
    }
    
    /* Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ½Ğ° Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ */
    #files {
        overflow-x: auto;
    }
    table {
        min-width: 500px; /* ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ¸ */
        box-shadow: none; 
    }
    th, td {
        padding: 10px 8px;
        font-size: 14px;
    }
    
    /* 5. ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾ĞºĞ½Ğ°: ĞĞ° Ğ²ĞµÑÑŒ ÑĞºÑ€Ğ°Ğ½ */
    #file-modal .content, #new-modal .content, #editor-modal .content { 
        max-width: 100vw; 
        max-height: 100vh;
        width: 100%;
        height: 100%;
        margin: 0;
        border-radius: 0;
        padding: 16px;
        box-sizing: border-box;
    }
    
    /* 6. ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¼ĞµĞ½Ñ "New" */
    #new-menu {
        top: 108px; /* ĞŸĞ¾Ğ´ toolbar */
        left: 16px;
        min-width: 80vw;
    }
}
</style>
</head>
<body>
<div>
        <button class="toggleButton" onclick="toggleMenu()">â˜°</button>
        <div class="user-widget" onclick="toggleUserMenu()">
            <img class="user-icn" src="https://cdn-icons-png.flaticon.com/128/17807/17807725.png" alt="Ğ˜ĞºĞ¾Ğ½ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ">
            <div class="user-widget-info">
                <div class="name">User Name</div>
                <div class="email"></div>
                <div class="pcoin">Pcoin 0</div>
            </div>
            </div>
            <div class="user-menu" id="userMenu" style="display: none;">
                <button onclick="window.location.href='accunt'">Setings</button>
                <button onclick="window.location.href='accunt'">top up balance Pcoin</button>
                <button onclick="window.location.href='riegist'">register or login</button>
            </div>

        <div class="menuContainer" id="menuContainer">
            <div class="appItem"><form action="results.html" method="get">
                <input type="text" name="query" placeholder="Enter your query" style="width: 70px ;height: 10px;" required>
                <button type="submit"style="height: 40px;width: 80px;">Search</button>
            </form></div>
            <div class="appItem" onclick="openApp('PerrotSoft-Play')">
                <i class="fab fa-google-play appIcon"></i>
                <span>Play</span>
            </div>
            <div class="appItem" onclick="openApp('https://perrotsoft.github.io/')">
                <img src="img/Home.png" alt="png">
                <span>Home</span>
            </div>
            <div class="appItem" onclick="openApp('Install_PerrotOS')">
                <img src="img/ico1.png" alt="png">
                <span>install OS</span>
            </div>
            <div class="appItem" onclick="openApp('datapedia')">
              <img src="img/datapedia icon1.png" alt="png">
              <span>dataPedia</span>
          </div>
        <div class="appItem" onclick="openApp('https://wavychatapp.github.io/')">
            <img src="https://wavychatapp.github.io/WavyChatApp.ico" width="30px" height="30px" alt="png">
            <span>WavyChatApp</span>
        </div>
            <div class="appItem" onclick="openApp('accunt')">
                <img src="img/as.png" alt="png">
                <span>Account settings.</span>
            </div>
            <div class="appItem" onclick="openApp('ParrotSoft_Apps')">
            <img src="img/Apps.png" width="30px" height="30px" alt="png">
            <span>ParrotSoft Apps</span>
        </div><div class="appItem" onclick="openApp('pdrive')">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16.5 13C18.433 13 20 11.433 20 9.5C20 7.74619 18.7397 6.27318 17.0706 6.04693C16.5925 3.39572 14.129 1 11 1C7.81792 1 5.30822 3.44494 4.88785 6.13689C2.79374 6.70321 1 8.87851 1 11.5C1 14.0044 2.80931 16 5 16H18C19.6569 16 21 14.6569 21 13C21 11.6667 19.9678 10.5518 18.5 10.1557" fill="#1A73E8"/>
                
                <path d="M10 18L14.5 14L15.5 15.5L13 18H10Z" fill="#34A853"/>
                <path d="M13 18L16 22L20 18H13Z" fill="#4285F4"/>
                <circle cx="15.5" cy="16.5" r="1.5" fill="#FFFFFF"/>
                <path d="M12 21C12 21.5523 11.5523 22 11 22C10.4477 22 10 21.5523 10 21C10 20.4477 10.4477 20 11 20C11.5523 20 12 20.4477 12 21Z" fill="#FBBC04"/>
                
                <path d="M5 11.5C5 9.84315 6.34315 8.5 8 8.5C9.65685 8.5 11 9.84315 11 11.5V11.5C11 13.1569 9.65685 14.5 8 14.5C6.34315 14.5 5 13.1569 5 11.5Z" fill="#FFFFFF" opacity="0.3"/>

            </svg>
            <span>ParrotSoft Drive</span>
        </div>
        </div>
        

<header>
  <div style="display: flex; align-items: center; gap: 8px; margin-left: 60px;">
    
    <span style="display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.5 13C18.433 13 20 11.433 20 9.5C20 7.74619 18.7397 6.27318 17.0706 6.04693C16.5925 3.39572 14.129 1 11 1C7.81792 1 5.30822 3.44494 4.88785 6.13689C2.79374 6.70321 1 8.87851 1 11.5C1 14.0044 2.80931 16 5 16H18C19.6569 16 21 14.6569 21 13C21 11.6667 19.9678 10.5518 18.5 10.1557" fill="#1A73E8"/>
        <path d="M10 18L14.5 14L15.5 15.5L13 18H10Z" fill="#34A853"/>
        <path d="M13 18L16 22L20 18H13Z" fill="#4285F4"/>
        <circle cx="15.5" cy="16.5" r="1.5" fill="#FFFFFF"/>
        <path d="M12 21C12 21.5523 11.5523 22 11 22C10.4477 22 10 21.5523 10 21C10 20.4477 10.4477 20 11 20C11.5523 20 12 20.4477 12 21Z" fill="#FBBC04"/>
        <path d="M5 11.5C5 9.84315 6.34315 8.5 8 8.5C9.65685 8.5 11 9.84315 11 11.5V11.5C11 13.1569 9.65685 14.5 8 14.5C6.34315 14.5 5 13.1569 5 11.5Z" fill="#FFFFFF" opacity="0.3"/>
      </svg>
      
    </span>
    
    PDrive
    
  </div>

</header>

<div class="toolbar" id="toolbar">
    <button id="btn-new">
        <span class="plus-icon">+</span> New
    </button><div id="new-menu"> <button id="btn-new-folder"><span class="icon">ğŸ“</span> New Folder</button><button id="btn-upload"><span class="icon">â¬†ï¸</span><span>ğŸ—ƒï¸</span> Upload file</button>
        <hr style="margin: 8px 0; border: none; border-top: 1px solid #e0e0e0; border-color: #e0e0e0;"><button id="btn-new-text"><span class="icon">ğŸ“„</span>Text file (.txt)</button><button id="btn-new-markdown"><span class="icon">ğŸ“</span>Markdown file (.md)</button><button id="btn-castom-text"><span class="icon">ğŸ“„</span>New My File</button>
    </div>

    <div style="flex-grow:1;"></div>
    <button id="btn-up">â¬†ï¸ Up</button> <button id="btn-view-link" style="display:none;">ğŸ”— Link</button> <button id="btn-delete">ğŸ—‘ï¸ Delete</button> <button id="btn-download">â¬‡ï¸ Download</button> <button id="btn-theme">ğŸŒ“ Theme</button> </div>

<div class="path" id="path">/</div>

<div id="files">
    <table>
        <thead>
            <tr>
                <th class="checkbox-col"><input type="checkbox" id="select-all"></th>
                <th>Name</th> <th>Type</th> </tr>
        </thead>
        <tbody id="file-list"><tr><td colspan="3">Loading...</td></tr></tbody> </table>
</div>

<div id="file-modal">
    <div class="content">
        <span class="close" id="modal-close">âœ–</span>
        <div id="modal-actions-bar">
            <button id="btn-edit" style="display:none;">âœï¸ Edit</button> </div>
        <h3 id="modal-filename"></h3>
        <div id="modal-body"></div>
    </div>
</div>

<div id="new-modal">
    <div class="content">
        <span class="close" id="new-modal-close">âœ–</span>
        <h3 id="new-modal-title"></h3>
        <label for="new-modal-name">Name:</label> <input type="text" id="new-modal-name" placeholder="Enter name"> <div class="modal-actions">
            <button id="btn-modal-cancel">Cancel</button> <button id="btn-modal-create">Create</button> </div>
    </div>
</div>

<div id="editor-modal">
    <div class="content">
        <span class="close" id="editor-modal-close">âœ–</span>
        <h3 id="editor-filename">Editing</h3> <textarea id="editor-textarea"></textarea>
        <div class="modal-actions">
            <button id="btn-editor-cancel">Cancel</button> <button id="btn-editor-save">Save</button> </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script type="module">
import "./js/firebase_db.js";
const JSZip1 = (await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js')).default;
import { PDrive } from "./js/PDrive.js";

// --- FIREBASE KEY FIX FUNCTIONS ---
function _encodeKey(key) {
Â  Â  if (!key) return key;
Â  Â  // Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ '.' Ğ½Ğ° ',' Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
Â  Â  return key.replace(/\./g, ',').replace(/#/g, '~h').replace(/\$/g, '~d').replace(/\[/g, '~l').replace(/\]/g, '~r');
}
function _decodeKey(key) {
Â  Â  if (!key) return key;
Â  Â  // ĞĞ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ Ğ·Ğ°Ğ¼ĞµĞ½Ğ°
Â  Â  return key.replace(/,/g, '.').replace(/~h/g, '#').replace(/~d/g, '$').replace(/~l/g, '[').replace(/~r/g, ']');
}

// --- UTILITY FUNCTIONS ---
function _getMimeType(filename) {
Â  Â  const ext = filename.split('.').pop().toLowerCase();
Â  Â  switch (ext) {
Â  Â  Â  Â  case 'png': return 'image/png';
Â  Â  Â  Â  case 'jpg': return 'image/jpg';
Â  Â  Â  Â  case 'jpeg': return 'image/jpeg';
Â  Â  Â  Â  case 'gif': return 'image/gif';
Â  Â  Â  Â  case 'txt': return 'text/plain';
        case 'ppsearch': return 'text/plain';
        case 'ppdatapedia': return 'text/plain';
        case 'txt': return 'text/plain';
Â  Â  Â  Â  case 'md': return 'text/markdown';
Â  Â  Â  Â  case 'html': return 'text/html';
Â  Â  Â  Â  case 'css': return 'text/css';
Â  Â  Â  Â  case 'js': return 'application/javascript';
Â  Â  Â  Â  case 'json': return 'application/json';
Â  Â  Â  Â  case 'pdf': return 'application/pdf';
Â  Â  Â  Â  case 'zip': return 'application/zip';
Â  Â  Â  Â  case 'mp3': return 'audio/mpeg';
Â  Â  Â  Â  case 'mp4': return 'video/mp4';
Â  Â  Â  Â  case 'svg': return 'image/svg+xml'; // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ SVG
Â  Â  Â  Â  default: return 'application/octet-stream';
Â  Â  }
}

/**
Â * ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ file Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¼ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ ÑĞ²Ğ½Ğ¾Ğ¼Ñƒ ÑĞ¿Ğ¸ÑĞºÑƒ.
Â * Ğ’ÑĞµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ fileÑ‹ ÑÑ‡Ğ¸Ñ‚Ğ°ÑÑ‚ÑÑ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸.
Â */
function _isBinaryFile(filename) {
Â  Â  const mime = _getMimeType(filename);
Â  Â  // Ğ¯Ğ²Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ² (Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ, Ğ¼ĞµĞ´Ğ¸Ğ°, Ğ°Ñ€Ñ…Ğ¸Ğ²Ñ‹, Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ)
Â  Â  return mime.startsWith('image/') && mime !== 'image/svg+xml' || // SVG Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ĞºĞ°Ğº Ñ‚ĞµĞºÑÑ‚
Â  Â  Â  Â  Â  Â mime.startsWith('audio/') || 
Â  Â  Â  Â  Â  Â mime.startsWith('video/') || 
Â  Â  Â  Â  Â  Â mime === 'application/pdf' || 
Â  Â  Â  Â  Â  Â mime === 'application/zip' || 
Â  Â  Â  Â  Â  Â mime === 'application/octet-stream'; // ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¼Ğ¸
}


function getCookie(name){const match=document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));return match?decodeURIComponent(match[2]):null;}
function setCookie(name,value,days=365){document.cookie=name+'='+encodeURIComponent(value)+';max-age='+(days*24*60*60)+';path=/';}

let currentPath="/", selectedFiles=new Set(), drive;
let currentEncodedPath = "";Â 
const user=getCookie("name");
const theme=getCookie("theme")||"light";
const newMenu=document.getElementById("new-menu");
const newModal=document.getElementById("new-modal");
const editorModal=document.getElementById("editor-modal");
const editorTextarea=document.getElementById("editor-textarea");
const newModalContent=document.querySelector("#new-modal .content");
const editorModalContent=document.querySelector("#editor-modal .content");
const fileModal=document.getElementById("file-modal");
const btnEdit=document.getElementById("btn-edit");
const btnViewLink = document.getElementById("btn-view-link"); // ĞĞ¾Ğ²Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°

if(theme==="dark"){Â 
Â  Â  document.body.classList.add("dark");Â 
Â  Â  document.querySelectorAll(".toolbar,th,tr,button").forEach(e=>e.classList.add("dark"));Â 
Â  Â  newMenu.classList.add("dark");
Â  Â  newModalContent.classList.add("dark");
Â  Â  editorModalContent.classList.add("dark");
}

if(!user){ alert("ĞÑˆĞ¸Ğ±ĞºĞ°: cookie 'name' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½."); }
else initDrive();

async function initDrive(){
Â  Â  drive=new PDrive(user);Â 
Â  Â Â 
Â  Â  // Ğ˜Ğ½Ğ¶ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ/Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
Â  Â  drive._encodeKey = _encodeKey;
Â  Â  drive._decodeKey = _decodeKey;

Â  Â  await drive.init();Â 
Â  Â  
    // --- ĞĞĞ’ĞĞ•: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑÑ‹Ğ»ĞºĞ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° fileĞ° ---
    await handleViewLink();
    // -------------------------------------------------

Â  Â  await refreshList();
}

async function refreshList(){
Â  Â  selectedFiles.clear();Â 
Â  Â  document.getElementById("select-all").checked=false;
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "Ğ¡ÑÑ‹Ğ»ĞºĞ°"
    btnViewLink.style.display = selectedFiles.size === 1 ? 'inline-block' : 'none';
    
Â  Â  let list=[];
Â  Â  try{Â 
Â  Â  Â  Â  list=await drive.listDir(currentPath);Â 
Â  Â  }catch(err){Â 
Â  Â  Â  Â  currentPath="/";Â 
Â  Â  Â  Â  document.getElementById("path").textContent=currentPath;Â 
Â  Â  Â  Â  list=await drive.listDir("/");Â 
Â  Â  }
Â  Â  const tbody=document.getElementById("file-list"); tbody.innerHTML="";
Â  Â  if(!list.length){ tbody.innerHTML="<tr><td colspan='3'>ĞŸÑƒÑÑ‚Ğ¾</td></tr>"; return; }
Â  Â Â 
Â  Â  for(const item of list){
Â  Â  Â  Â  const decodedName = drive._decodeKey ? drive._decodeKey(item.name) : item.name;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let fileType;
Â  Â  Â  Â  if (item.type === 'folder') {
Â  Â  Â  Â  Â  Â  fileType = 'Forder';
Â  Â  Â  Â  } else if (_isBinaryFile(decodedName)) {
Â  Â  Â  Â  Â  Â  const mime = _getMimeType(decodedName);
Â  Â  Â  Â  Â  Â  if (mime.startsWith('image/')) {
Â  Â  Â  Â  Â  Â  Â  Â  fileType = 'Image';
Â  Â  Â  Â  Â  Â  } else if (mime === 'application/pdf') {
Â  Â  Â  Â  Â  Â  Â  Â  fileType = 'PDF-Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚';
Â  Â  Â  Â  Â  Â  } else if (mime === 'application/zip') {
Â  Â  Â  Â  Â  Â  Â  Â  fileType = 'ĞÑ€Ñ…Ğ¸Ğ² (.zip)';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  fileType = 'Binary';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const mime = _getMimeType(decodedName);
Â  Â  Â  Â  Â  Â  if(mime === 'image/svg+xml') {
Â  Â  Â  Â  Â  Â  Â  Â  fileType = 'SVG-Image (Ğ¢ĞµĞºÑÑ‚)';
Â  Â  Â  Â  Â  Â  } else if(mime === 'text/markdown') {
Â  Â  Â  Â  Â  Â  Â  Â  fileType = 'Markdown-Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  fileType = 'Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ file';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const tr=document.createElement("tr");
Â  Â  Â  Â  tr.dataset.name=decodedName;Â 
Â  Â  Â  Â  tr.dataset.encodedName=item.name;Â 
Â  Â  Â  Â  tr.dataset.type=item.type;
Â  Â  Â  Â  tr.innerHTML=`<td class="checkbox-col"><input type="checkbox" class="select-file"></td><td>${item.type === 'folder' ? 'ğŸ“ ' : ''}${decodedName}</td><td>${fileType}</td>`;Â 
Â  Â  Â  Â  tr.querySelector(".select-file").onclick=e=>{
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  if(e.target.checked) selectedFiles.add(decodedName); else selectedFiles.delete(decodedName);
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "Ğ¡ÑÑ‹Ğ»ĞºĞ°"
            btnViewLink.style.display = selectedFiles.size === 1 ? 'inline-block' : 'none';
Â  Â  Â  Â  };
Â  Â  Â  Â  tr.ondblclick=async()=>{
Â  Â  Â  Â  Â  Â  const fullEncodedPath = currentPath + "/" + item.name;
Â  Â  Â  Â  Â  Â  if(item.type==="folder"){Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentPath=currentPath.replace(/\/$/,"")+"/"+decodedName;Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("path").textContent=currentPath;Â 
Â  Â  Â  Â  Â  Â  Â  Â  await refreshList();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else await openFile(fullEncodedPath, decodedName);Â 
Â  Â  Â  Â  };
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  }
}
// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Base64-ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Unicode
// (Ğ­Ñ‚Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ½ĞµÑÑ‚Ğ¸ Ğ·Ğ° Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñ‹ openFile, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ½ÑƒĞ¶Ğ½Ğ° Ğ³Ğ´Ğµ-Ñ‚Ğ¾ ĞµÑ‰Ğµ)
const safeBtoa = (str) => {
    // ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ UTF-8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ encodeURIComponent, Ğ·Ğ°Ñ‚ĞµĞ¼ "Ñ€Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" Ğ¸Ñ… Ğ² Ğ±Ğ°Ğ¹Ñ‚Ñ‹ Ğ´Ğ»Ñ btoa
    return btoa(unescape(encodeURIComponent(str)));
};

// Modal open (Viewer)
async function openFile(encodedPath, decodedName){
    currentEncodedPath = encodedPath;
    const node = drive._getNode(drive._resolvePath(encodedPath), true);
    if (!node) return;
    
    document.getElementById("modal-filename").textContent = decodedName; 
    const body = document.getElementById("modal-body"); 
    body.innerHTML = "";
    btnEdit.style.display = 'none'; 
    
    const mimeType = _getMimeType(decodedName);

    if (mimeType.startsWith('image/png')||mimeType.startsWith('image/jpg')||mimeType.startsWith('image/gif')||mimeType.startsWith('image/jpeg')) {
        // 1. Ğ‘Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ (png, jpg, gif)
        // ĞŸÑ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ node.value ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ URL-encoded DataURL.
        const dataUrl = decodeURIComponent(node.value);
        console.log(node.value);
        
        const img = document.createElement("img");
        img.id = "modal-image";
        img.src = dataUrl; // Ğ£Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğµ decodeURIComponent
        body.appendChild(img);
        
    } else if (mimeType.startsWith('image/') && !node.binary) { 
        // 2. SVG (Ğ¢ĞµĞºÑÑ‚)
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ safeBtoa Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Unicode Ğ² SVG Ñ‚ĞµĞºÑÑ‚Ğµ
        const base64Content = safeBtoa(node.value);
        const dataUrl = `data:${mimeType};base64,${base64Content}`; // ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ DataURL
        
        const img = document.createElement("img");
        img.id = "modal-image";
        img.src = dataUrl;
        body.appendChild(img);
        btnEdit.style.display = 'inline-block'; // SVG Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğº Ñ‚ĞµĞºÑÑ‚
        
    } else if (decodedName.endsWith(".md")) {
        // 3. Markdown
        const renderedDiv = document.createElement("div");
        renderedDiv.innerHTML = marked.parse(node.value);
        body.appendChild(renderedDiv);
        
        const rawDiv = document.createElement("div");
        rawDiv.id = "markdown-raw-view";
        rawDiv.innerHTML = `<h4>Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚:</h4><pre>${node.value}</pre>`;
        body.appendChild(rawDiv);
        
        btnEdit.style.display = 'inline-block';
    } else if (!node.binary) { 
        // 4. Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¸ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ğ½Ñ‹Ğµ fileÑ‹
        const pre = document.createElement("pre"); 
        pre.textContent = node.value; 
        body.appendChild(pre);
        
        btnEdit.style.display = 'inline-block';
    } else {
        // 5. ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ fileÑ‹
        const a = document.createElement("a"); 
        a.href = "javascript:void(0)"; 
        a.textContent = `Binary file (${mimeType}): unavailable for viewing`; 
        body.appendChild(a);
    }
    
    fileModal.style.display = "flex";
}

// --- ĞĞĞ’ĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯: ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ˜Ğ• fileĞ ĞŸĞ Ğ¡Ğ¡Ğ«Ğ›ĞšĞ• (Read-Only) ---

/**
 * ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ file Ğ² Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¾ĞºĞ½Ğµ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ PDrive.
 * @param {PDrive} pdriveInstance Ğ­ĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ PDrive Ğ´Ğ»Ñ Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
 * @param {Object} node Ğ£Ğ·ĞµĞ» fileĞ°.
 * @param {string} fullDecodedPath ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº fileÑƒ.
 * @param {string} userName Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ¸Ñ‚ file.
 */
async function openFileInReadOnlyMode(pdriveInstance, node, fullDecodedPath, userName) {
    document.getElementById("modal-filename").textContent = `[READING] ${fullDecodedPath} (Ğ¾Ñ‚ ${userName})`;Â 
    const body = document.getElementById("modal-body"); body.innerHTML = "";
    btnEdit.style.display = 'none'; // Ğ’ÑĞµĞ³Ğ´Ğ° ÑĞºÑ€Ñ‹Ñ‚Ğ¾ Ğ´Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ
    
    // ĞŸĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ mimeType, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ Ğ¿ÑƒÑ‚ĞµĞ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, /folder/file.txt)
    const decodedName = fullDecodedPath.split('/').pop();
    const mimeType = _getMimeType(decodedName);

    if (mimeType.startsWith('image/png')||mimeType.startsWith('image/jpg')||mimeType.startsWith('image/gif')||mimeType.startsWith('image/jpeg')) {
        // 1. Ğ‘Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ (png, jpg, gif)
        const dataUrl = decodeURIComponent(`data:${mimeType};base64,${node.value}`);
        const img = document.createElement("img");
        img.id = "modal-image";
        img.src = decodeURIComponent(dataUrl);
        body.appendChild(img);
    } else if(mimeType.startsWith('image/') && !node.binary) { 
        // 2. SVG (Ñ‚ĞµĞºÑÑ‚)
        const dataUrl = `data:${mimeType};base64,${btoa(node.value)}`;
        const img = document.createElement("img");
        img.id = "modal-image";
        img.src = dataUrl;
        body.appendChild(img);
    } else if (decodedName.endsWith(".md")) {
        // 3. Markdown
        const renderedDiv = document.createElement("div");
        renderedDiv.innerHTML = marked.parse(node.value);
        body.appendChild(renderedDiv);
        
        const rawDiv = document.createElement("div");
        rawDiv.id = "markdown-raw-view";
        rawDiv.innerHTML = `<h4>Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚:</h4><pre>${node.value}</pre>`;
        body.appendChild(rawDiv);
    } else if (!node.binary) { // 4. Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ fileÑ‹
        const pre = document.createElement("pre");Â 
        pre.textContent = node.value;Â 
        body.appendChild(pre);
    } else {
        // 5. ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ fileÑ‹
        const p = document.createElement("p");
        p.textContent = `Binary file (${mimeType}): unavailable for viewing.`;
        body.appendChild(p);
    }
    
    fileModal.style.display = "flex";
}


/**
 * ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ…ÑÑˆ URL Ğ´Ğ»Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ fileĞ° Ğ¿Ğ¾ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞµ.
 * ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ…ÑÑˆĞ°: #view/[username]/[path/to/file.ext]
 */
async function handleViewLink() {
    const hash = window.location.hash;
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ…ÑÑˆ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ #view/ Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ
    if (hash.startsWith('#view/')) {
        const path = hash.substring(6); // path: [username]/[path/to/file.ext]
        const parts = path.split('/'); 

        if (parts.length < 2) {
             alert("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°. ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ: #view/[username]/[path/to/file.ext]");
             return;
        }

        // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        const targetUser = parts[0]; 
        
        // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğº fileÑƒ (Ğ²ÑĞµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ)
        const filePathDecoded = '/' + parts.slice(1).join('/'); 
        
        // ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ, ĞºĞ°Ğº ÑÑ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° PDrive
        const filePathEncodedParts = ['']; // ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ ĞºĞ¾Ñ€Ğ½Ñ
        for (let i = 1; i < parts.length; i++) {
            filePathEncodedParts.push(_encodeKey(parts[i]));
        }
        const filePathEncoded = filePathEncodedParts.join('/'); // /folder_encoded/file_encoded.txt
        
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ PDrive Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº fileĞ°Ğ¼ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        document.getElementById("file-list").innerHTML = '<tr><td colspan="3">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° fileĞ° Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ...</td></tr>';

        try {
            const viewDrive = new PDrive(targetUser);
            viewDrive._encodeKey = _encodeKey;
            viewDrive._decodeKey = _decodeKey;
            // Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ (Ğ‘Ğ” ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚)
            await viewDrive.init(); 

            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ·ĞµĞ», Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ _resolvePath Ğ½Ğ° Ğ—ĞĞšĞĞ”Ğ˜Ğ ĞĞ’ĞĞĞĞĞœ Ğ¿ÑƒÑ‚Ğ¸
            const pathSegments = viewDrive._resolvePath(filePathEncoded);
            const fileNode = viewDrive._getNode(pathSegments, false);

            if (fileNode && fileNode.type === 'file') {
                // ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ
                await openFileInReadOnlyMode(viewDrive, fileNode, filePathDecoded, targetUser);
            } else {
                alert(`ĞÑˆĞ¸Ğ±ĞºĞ°: file '${filePathDecoded}' Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ '${targetUser}' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ğ°Ğ¿ĞºĞ¾Ğ¹.`);
            }
        } catch (e) {
            alert(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ fileĞ°: ${e.message}. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ '${targetUser}' Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.`);
        }
    }
}


document.getElementById("modal-close").onclick=()=>fileModal.style.display="none";

// ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğ°
btnEdit.onclick = () => {
Â  Â  fileModal.style.display = 'none';
Â  Â  editFile(currentEncodedPath);
};

// --- EDITOR LOGIC ---
async function editFile(encodedPath) {
Â  Â  const node = drive._getNode(drive._resolvePath(encodedPath), false);
Â  Â  // Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ°ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ fileÑ‹ Ğ˜ SVG (ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ ĞºĞ°Ğº Ñ‚ĞµĞºÑÑ‚)
Â  Â  const decodedName = drive._decodeKey(encodedPath.split('/').pop());
Â  Â  const isSvg = _getMimeType(decodedName) === 'image/svg+xml';
Â  Â  
Â  Â  if (!node || (node.binary && !isSvg)) { alert("ĞÑˆĞ¸Ğ±ĞºĞ°: ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ file."); return; }
Â  Â Â 
Â  Â  document.getElementById("editor-filename").textContent = decodedName;
Â  Â  editorTextarea.value = node.value;
Â  Â  editorModal.style.display = 'flex';
}

document.getElementById("editor-modal-close").onclick = () => editorModal.style.display = "none";
document.getElementById("btn-editor-cancel").onclick = () => editorModal.style.display = "none";

document.getElementById("btn-editor-save").onclick = async () => {
Â  Â  const newContent = editorTextarea.value;
Â  Â  editorModal.style.display = "none";
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  // ĞŸÑ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ fileĞ° (Ğ¸Ğ»Ğ¸ SVG, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº Ñ‚ĞµĞºÑÑ‚)
Â  Â  Â  Â  // isBinary Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ false
Â  Â  Â  Â  await drive.writeFile(currentEncodedPath, newContent, false);Â 
Â  Â  Â  Â  await refreshList();
Â  Â  Â  Â  alert("file ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½!");
Â  Â  } catch (e) {
Â  Â  Â  Â  alert("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ: " + e.message);
Â  Â  }
};


// --- NEW MODAL LOGIC (Creation) ---
let modalAction = null;

function openNewModal(title, actionType) {
Â  Â  newMenu.style.display = "none";
Â  Â  document.getElementById("new-modal-title").textContent = title;
Â  Â  document.getElementById("new-modal-name").value = "";
Â  Â  document.getElementById("new-modal-name").focus();
Â  Â  modalAction = actionType;
Â  Â  newModal.style.display = "flex";
}

document.getElementById("new-modal-close").onclick = () => newModal.style.display = "none";
document.getElementById("btn-modal-cancel").onclick = () => newModal.style.display = "none";

document.getElementById("btn-modal-create").onclick = async () => {
Â  Â  const nameInput = document.getElementById("new-modal-name");
Â  Â  const name = nameInput.value.trim();
Â  Â  if (!name) { alert("Ğ˜Ğ¼Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼."); return; }

Â  Â  newModal.style.display = "none";
Â  Â Â 
Â  Â  let finalName = name;
Â  Â Â 
Â  Â  if (modalAction === 'text' && !name.endsWith(".txt")) {
Â  Â  Â  Â  finalName += ".txt";
Â  Â  } else if (modalAction === 'markdown' && !name.endsWith(".md")) {
Â  Â  Â  Â  finalName += ".md";
Â  Â  }

Â  Â  const encodedName = drive._encodeKey(finalName);Â 
Â  Â  const fullEncodedPath = currentPath + "/" + encodedName;
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  if (modalAction === 'folder') {
Â  Â  Â  Â  Â  Â  await drive.mkdir(fullEncodedPath);
Â  Â  Â  Â  } else if (modalAction === 'text' || modalAction === 'markdown' || modalAction === 'null') {
Â  Â  Â  Â  Â  Â  // ĞŸÑ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ fileĞ° Ğ¾Ğ½ Ğ²ÑĞµĞ³Ğ´Ğ° Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ (binary=false)
Â  Â  Â  Â  Â  Â  let initialContent = (modalAction === 'markdown') ? `# ${finalName.replace(/\.md$/i, '')}` : "";
Â  Â  Â  Â  Â  Â  await drive.writeFile(fullEncodedPath, initialContent, false);
Â  Â  Â  Â  }
Â  Â  Â  Â  await refreshList();
Â  Â  } catch (e) {
Â  Â  Â  Â  alert("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ: " + e.message);
Â  Â  }
};

// --- BUTTON HANDLERS ---
document.getElementById("btn-new").onclick=()=>{
Â  Â  newMenu.style.display = newMenu.style.display === "block" ? "none" : "block";
};

document.addEventListener('click', (event) => {
Â  Â  if (!document.getElementById("btn-new").contains(event.target) && !newMenu.contains(event.target) && !newModal.contains(event.target) && !editorModal.contains(event.target) && !fileModal.contains(event.target)) {
Â  Â  Â  Â  newMenu.style.display = 'none';
Â  Â  }
});

document.getElementById("btn-up").onclick=async()=>{Â 
Â  Â  if(currentPath==="/") return;Â 
Â  Â  const parts=currentPath.split("/").filter(p=>p);Â 
Â  Â  parts.pop();Â 
Â  Â  currentPath="/"+parts.join("/");Â 
Â  Â  document.getElementById("path").textContent=currentPath;Â 
Â  Â  await refreshList();Â 
};

// New folder opens modal
document.getElementById("btn-new-folder").onclick=async()=>{Â 
Â  Â  openNewModal("New Folder", "folder");
};

// --- ĞĞĞ’ĞĞ¯ ĞšĞĞĞŸĞšĞ: Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ---
btnViewLink.onclick = () => {
    if (selectedFiles.size !== 1) return;
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ fileĞ°
    const fileName = selectedFiles.values().next().value;
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ
    const fullPath = currentPath === "/" ? `/${fileName}` : `${currentPath}/${fileName}`;
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑÑ‹Ğ»ĞºÑƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ: #view/[username]/[path/to/file.ext]
    const link = `${window.location.origin}${window.location.pathname}#view/${user}${fullPath}`;

    // ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑÑ‹Ğ»ĞºÑƒ Ğ² Ğ±ÑƒÑ„ĞµÑ€ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°
    navigator.clipboard.writeText(link).then(() => {
        alert(`Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° (${fileName}) ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ² Ğ±ÑƒÑ„ĞµÑ€ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°:\n${link}`);
    }).catch(err => {
        console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑÑ‹Ğ»ĞºĞ¸: ', err);
        alert(`ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ. Ğ¡ÑÑ‹Ğ»ĞºĞ°:\n${link}`);
    });
};


// !!! Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ˜ fileĞĞ’ !!!
document.getElementById("btn-upload").onclick=async()=>{
Â  Â  newMenu.style.display = "none";
Â  Â  const fileInput=document.createElement("input");Â 
Â  Â  fileInput.type="file";
Â  Â  fileInput.onchange=async()=>{Â 
Â  Â  Â  Â  const file=fileInput.files[0];Â 
Â  Â  Â  Â  const reader=new FileReader();Â 
Â  Â  Â  Â  const isBinary = _isBinaryFile(file.name); // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ

Â  Â  Â  Â  document.getElementById("file-list").innerHTML = '<tr><td colspan="3">Loading file... Don\'t close the window!</td></tr>';

Â  Â  Â  Â  reader.onload=async()=>{Â 
Â  Â  Â  Â  Â  Â  let data;
Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  data = reader.result;Â 


Â  Â  Â  Â  Â  Â  const encodedFileName = drive._encodeKey(file.name);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await drive.writeFile(currentPath+"/"+encodedFileName, data, isBinary);Â 
Â  Â  Â  Â  Â  Â  Â  Â  await refreshList();Â 
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² PDrive: " + e.message);
Â  Â  Â  Â  Â  Â  Â  Â  await refreshList();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ file Ğ² ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ñ ĞµĞ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ¾Ğ¼
Â  Â  Â  Â  if (!isBinary) {
Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file); // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ°Ğº Base64
Â  Â  Â  Â  }
Â  Â  };
Â  Â  fileInput.click();
};

document.getElementById("btn-new-text").onclick=async()=>{
Â  Â  openNewModal("New Text file", "text");
};
document.getElementById("btn-castom-text").onclick=async()=>{
Â  Â  openNewModal("New file", "null");
};
// Create new Markdown File opens modal
document.getElementById("btn-new-markdown").onclick=async()=>{
Â  Â  openNewModal("New Markdown file", "markdown");
};

document.getElementById("btn-delete").onclick=async()=>{
Â  Â  if(!selectedFiles.size){ alert("Select elements"); return; }
Â  Â  if(!confirm("Delete selected items?")) return;
Â  Â Â 
Â  Â  for(const name of selectedFiles) {
Â  Â  Â  Â  const encodedName = drive._encodeKey(name);
Â  Â  Â  Â  await drive.delete(currentPath+"/"+encodedName);
Â  Â  }
Â  Â  selectedFiles.clear();Â 
Â  Â  await refreshList();
};


// --- Ğ›ĞĞ“Ğ˜ĞšĞ Ğ¡ĞšĞĞ§Ğ˜Ğ’ĞĞĞ˜Ğ¯ fileĞĞ’ ---
// Ğ ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°
async function addNodeToZip(zip, node, nodeFullPath) {
Â  Â  // nodeFullPath: Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ PDrive-Ğ¿ÑƒÑ‚ÑŒ, ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ—ĞĞšĞĞ”Ğ˜Ğ ĞĞ’ĞĞĞĞ«Ğ• Ğ¸Ğ¼ĞµĞ½Ğ°
Â  Â Â 
Â  Â  // 1. ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¿ÑƒÑ‚Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°
Â  Â  const pathParts = nodeFullPath.split('/').filter(p => p);
Â  Â  const decodedPathParts = pathParts.map(drive._decodeKey);
Â  Â  // ĞŸÑƒÑ‚ÑŒ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°
Â  Â  const fullZipPath = decodedPathParts.join('/');Â 
Â  Â Â 
Â  Â  if (node.type === "file") {
Â  Â  Â  Â  let content;
Â  Â  Â  Â  if (node.binary) {
Â  Â  Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Binary file, node.value - ÑÑ‚Ğ¾ Ñ‡Ğ¸ÑÑ‚Ğ°Ñ Base64 ÑÑ‚Ñ€Ğ¾ĞºĞ°
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const binary = atob(node.value); // Ğ”ĞµĞºĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Base64
Â  Â  Â  Â  Â  Â  Â  Â  const array = new Uint8Array(binary.length);
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
Â  Â  Â  Â  Â  Â  Â  Â  content = array;
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Base64 decoding failed for file:", node.name, e);
Â  Â  Â  Â  Â  Â  Â  Â  content = new Uint8Array(0);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Ğ”Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… fileĞ¾Ğ² (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ SVG), node.value - ÑÑ‚Ğ¾ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚
Â  Â  Â  Â  Â  Â  content = node.value;
Â  Â  Â  Â  }
Â  Â  Â  Â  zip.file(fullZipPath, content);
Â  Â  } else if (node.type === "folder") {
Â  Â  Â  Â  zip.folder(fullZipPath + "/");Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const children = await drive.listDir(nodeFullPath);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (const child of children) {
Â  Â  Â  Â  Â  Â  Â  Â  const childNodeFullPath = nodeFullPath + "/" + child.name;
Â  Â  Â  Â  Â  Â  Â  Â  const childNode = drive._getNode(drive._resolvePath(childNodeFullPath), false);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (childNode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addNodeToZip(zip, childNode, childNodeFullPath);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error("Error listing directory for zip:", nodeFullPath, e);
Â  Â  Â  Â  }
Â  Â  }
}
function base64ToUint8Array(base64) {
    const raw = atob(base64);
    const rawLength = raw.length;
    const array = new Uint8Array(rawLength);

    for (let i = 0; i < rawLength; i++) {
        array[i] = raw.charCodeAt(i);
    }
    return array;
}
// ... (Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ base64ToUint8Array Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹) ...

// *Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ drive Ğ¸ addNodeToZip Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ÑÑ‚ÑÑ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼Ğ¸*
// *Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ _isBinaryFile Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ÑÑ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ¹*

/**
 * Ğ ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑƒĞ·ĞµĞ» (Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ğ¿ĞºÑƒ) Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞµĞ³Ğ¾ Ğ² ZIP.
 * @param {JSZip} zip - Ğ­ĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ JSZip.
 * @param {Object} node - Ğ£Ğ·ĞµĞ» Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹.
 * @param {string} fullPath - ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº ÑƒĞ·Ğ»Ñƒ Ğ² Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ (Ğ”Ğ•ĞšĞĞ”Ğ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™).
 * @param {string} rootPathForZip - Ğ§Ğ°ÑÑ‚ÑŒ Ğ¿ÑƒÑ‚Ğ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€ÑƒÑ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ñ‚Ñ€ĞµĞ·Ğ°Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ZIP-Ğ¿ÑƒÑ‚ÑŒ.
 */
async function processNodeForZip(zip, node, fullPath, rootPathForZip) {
    const pathParts = drive._resolvePath(fullPath); 
    const name = pathParts.pop(); 
    
    // 1. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°
    const zipPathBase = fullPath.startsWith('/') ? fullPath.substring(1) : fullPath;
    const zipPathRelativeToRoot = zipPathBase.startsWith(rootPathForZip) 
        ? zipPathBase.substring(rootPathForZip.length) 
        : zipPathBase;
        
    const cleanZipPath = zipPathRelativeToRoot.startsWith('/') 
        ? zipPathRelativeToRoot.substring(1) 
        : zipPathRelativeToRoot;

    // ğŸ”´ ĞĞĞ’ĞĞ• Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ—Ğ°Ğ¼ĞµĞ½Ğ° Ğ²ÑĞµÑ… Ğ·Ğ°Ğ¿ÑÑ‚Ñ‹Ñ… (,) Ğ½Ğ° Ñ‚Ğ¾Ñ‡ĞºĞ¸ (.) Ğ² Ğ¿ÑƒÑ‚Ğ¸ ZIP
    const zipPath = cleanZipPath.replace(/,/g, '.'); // <--- ğŸŒŸ Ğ’Ğ¾Ñ‚ Ğ·Ğ´ĞµÑÑŒ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ·Ğ°Ğ¼ĞµĞ½Ğ°

    if (zipPath === "") {
        console.log(`Skipping root element for ZIP path: ${fullPath}`);
    }


    if (node.type === 'file') {
        // --- Ğ‘Ğ›ĞĞš ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ˜ Ğ¤ĞĞ™Ğ›Ğ (Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¸ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ) ---
        let fileContent;
        try {
            fileContent = await drive.readFile(fullPath); 
        } catch (e) {
            console.error(`Error reading file ${name} (might be missing parts):`, e);
            return; 
        }
        
        // ... (Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Data URL Ğ² Uint8Array Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€ĞµĞ¶Ğ½ĞµĞ¹) ...
        // ... (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ fileContent) ...
        if (fileContent && typeof fileContent === 'string' && fileContent.startsWith('data:')) {
            const dataUrl = decodeURIComponent(fileContent);
            const base64PartWithCruft = dataUrl.split(',')[1];
            const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1).split(';')[0];
            
            if (_isBinaryFile(mimeType) && base64PartWithCruft) { 
                let cleanBase64 = base64PartWithCruft.replace(/\s/g, ''); 
                while (cleanBase64.length % 4 !== 0) { cleanBase64 += '='; }
                try {
                    fileContent = base64ToUint8Array(cleanBase64); 
                } catch(e) {
                    console.error(`Error converting Base64 to Uint8Array for ${name}. Skipping file.`, e);
                }
            }
        }
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ğ² ZIP, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ zipPath
        if (zipPath) {
            const isBinary = fileContent instanceof Uint8Array || fileContent instanceof ArrayBuffer;
            zip.file(zipPath, fileContent, { binary: isBinary });
            console.log(`Added file to ZIP: ${zipPath}`);
        }
        
    } else if (node.type === 'folder' && node.children) {
        // --- Ğ‘Ğ›ĞĞš ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ˜ ĞŸĞĞŸĞšĞ˜ (Ğ ĞµĞºÑƒÑ€ÑĞ¸Ñ) ---
        console.log(`Processing folder recursively: ${name}`);
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ°Ğ¼Ñƒ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ² ZIP, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ zipPath
        if (zipPath) {
            zip.folder(zipPath); 
            console.log(`Created folder in ZIP: ${zipPath}`);
        }
        
        // Ğ ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ²ÑĞµ Ğ´Ğ¾Ñ‡ĞµÑ€Ğ½Ğ¸Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹
        for (const childName in node.children) {
            if (childName.includes('_part')) continue; 
            
            if (Object.hasOwnProperty.call(node.children, childName)) {
                const childNode = node.children[childName];
                
                const decodedChildName = decodeURIComponent(childName);
                const newFullPath = fullPath + (fullPath.endsWith('/') ? '' : '/') + decodedChildName;
                
                // Ğ ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ²
                await processNodeForZip(zip, childNode, newFullPath, rootPathForZip);
            }
        }
    }
}
// --- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ’ ONCLICK ---
document.getElementById("btn-download").onclick = async () => {
    if (!selectedFiles.size) { 
        alert("Select elements"); 
        return; 
    }
    document.getElementById("file-list").innerHTML = '<tr><td colspan="3">Preparing to download... Do not close the window!</td></tr>';

    const zip = new JSZip();

    for (const name of selectedFiles) {
        // 'name' â€” Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° (Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ğ¿ĞºĞ°)
        
        // 1. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñƒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, /user/current/file.txt)
        let fullPath = currentPath;
        if (!fullPath.endsWith('/')) {
            fullPath += '/';
        }
        fullPath += name; 
        
        // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ·ĞµĞ»
        const node1 = drive._getNode(drive._resolvePath(fullPath), false); 
        
        if (!node1) continue;
        
        // 3. ğŸ›‘ ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ¯Ğ•Ğœ Ğ‘ĞĞ—ĞĞ’Ğ«Ğ™ ĞŸĞ£Ğ¢Ğ¬ Ğ”Ğ›Ğ¯ ZIP
        // Ğ­Ñ‚Ğ¾ Ñ‡Ğ°ÑÑ‚ÑŒ, ĞºĞ¾Ñ‚Ğ¾Ñ€ÑƒÑ Ğ½ÑƒĞ¶Ğ½Ğ¾ "Ğ¾Ñ‚Ñ€ĞµĞ·Ğ°Ñ‚ÑŒ", Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ„Ğ°Ğ¹Ğ» Ğ¾ĞºĞ°Ğ·Ğ°Ğ»ÑÑ Ğ² ĞºĞ¾Ñ€Ğ½Ğµ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°.
        // Ğ•ÑĞ»Ğ¸ currentPath = /A/B, Ğ¸ Ğ¼Ñ‹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ C, Ñ‚Ğ¾ rootPathForZip = /A/B/
        
        let rootPathForZip = currentPath;
        if (!rootPathForZip.endsWith('/')) {
             rootPathForZip += '/';
        }

        // 4. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ
        await processNodeForZip(zip, node1, fullPath, rootPathForZip); 
    }
    
    // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°
    const blob = await zip.generateAsync({ type: "blob" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "archive.zip";
    a.click();
    await refreshList(); 
};
document.getElementById("btn-theme").onclick=()=>{
Â  Â  const isDark = document.body.classList.contains("dark");
Â  Â  document.body.classList.toggle("dark", !isDark);Â 
Â  Â  newMenu.classList.toggle("dark", !isDark);
Â  Â  newModalContent.classList.toggle("dark", !isDark);
Â  Â  editorModalContent.classList.toggle("dark", !isDark);

Â  Â  document.querySelectorAll(".toolbar,th,tr,button").forEach(e => e.classList.toggle("dark", !isDark));Â 
Â  Â  setCookie("theme", isDark ? "light" : "dark");
};

document.getElementById("select-all").onclick=(e)=>{Â 
Â  Â  document.querySelectorAll(".select-file").forEach(cb=>{Â 
Â  Â  Â  Â  cb.checked=e.target.checked;Â 
Â  Â  Â  Â  const name = cb.closest("tr").dataset.name;
Â  Â  Â  Â  if(e.target.checked) selectedFiles.add(name); else selectedFiles.delete(name);Â 
Â  Â  });Â 
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "Ğ¡ÑÑ‹Ğ»ĞºĞ°"
    btnViewLink.style.display = selectedFiles.size === 1 ? 'inline-block' : 'none';
};
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>