<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="img/ico.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style1.css">
    <script src="js/sitefun.js" type="module"></script>
    <script src="js/user.js"></script>
    <style>
        /* Общие стили для нового макета */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #F2F2F2;
            margin: 0;
            padding-top: 60px; /* Отступ сверху для фиксированного верхнего меню */
            display: flex;
            min-height: 100vh;
        }

        /* ------------------------------------- */
        /* Боковое меню (Sidebar) - GitHub Style */
        /* ------------------------------------- */
        nav {
            background-color: #2F363D; /* Темный фон */
            width: 250px;
            min-width: 200px;
            padding: 10px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5); /* Более заметная тень */
            position: fixed;
            height: 100%;
            overflow-y: auto;
            top: 0;
            left: 0;
            z-index: 99;
            box-sizing: border-box;
            padding-top: 70px;
        }

        /* Заголовок кластера */
        .cluster-title {
            color: #A9B2BB; /* Светло-серый текст */
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 15px 15px 5px 15px;
            margin-top: 5px;
        }

        /* Разделительная линия между кластерами */
        .cluster-separator {
            border: none;
            height: 1px;
            background-color: #444C56; /* Темная линия */
            margin: 5px 15px;
        }

        /* Стиль ссылок в боковом меню */
        nav a {
            text-decoration: none;
            display: block;
            margin: 0;
            color: #C8D1D9; /* Светлый текст */
            font-size: 15px;
            padding: 10px 15px;
            border-left: 3px solid transparent;
            transition: background-color 0.2s, border-left-color 0.2s, color 0.2s;
        }

        nav a:hover {
            background-color: #444C56; /* Темный ховер */
            color: #FFFFFF;
        }

        nav a.active {
            background-color: #3C444B; /* Фон активного пункта */
            border-left-color: #0366D6; /* Синий акцент */
            font-weight: 600;
            color: #FFFFFF;
        }
        /* ------------------------------------- */

        /* Основное содержимое */
        .main-content {
            margin-left: 250px; /* Ширина навигации */
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
            box-sizing: border-box;
        }

        /* Верхняя панель пользователя (сохранена) */
        .top-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #1A73E8;
            color: white;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Стиль для инпутов в контенте */
        .settings-container label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .settings-container input[type="text"],
        .settings-container input[type="password"] {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .settings-container .button {
            display: inline-block;
            width: auto;
            min-width: 150px;
            margin-top: 20px;
            padding: 10px 20px;
            /* Переопределение оригинального стиля кнопки */
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
        }
        .settings-container .button:hover {
            background: #0c5dc0;
        }

        .user-icn1 {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Переопределяем стили для мобильных устройств */
        @media (max-width: 768px) {
            body {
                padding-top: 50px;
                flex-direction: column;
            }
            .top-panel {
                height: 50px;
            }
            /* Навигация скрыта по умолчанию на мобильных */
            nav {
                position: absolute;
                left: 0;
                top: 0;
                width: 70vw;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s;
                padding-top: 50px;
            }
            nav.active {
                transform: translateX(0);
                box-shadow: 5px 0 10px rgba(0, 0, 0, 0.3);
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
                width: 100%;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>

    <div class="top-panel">
        <button class="toggleButton" onclick="toggleNavMenu()" style="margin-left: 10px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">☰</button>
        <div style="font-size: 20px; font-weight: bold;">Account Settings</div>
        <div class="user-widget" onclick="toggleUserMenu()" style="position: relative; right: 10px; cursor: pointer;">
            <img class="user-icn" src="https://cdn-icons-png.flaticon.com/128/17807/17807725.png" alt="Профиль" style="width: 32px; height: 32px; border-radius: 50%;">
        </div>
    </div>
    
    <div class="user-menu" id="userMenu" style="display: none; position: fixed; right: 10px; top: 60px; z-index: 1000; background: white; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 10px; border-radius: 8px;">
        <button onclick="window.location.href='accunt'" style="display: block; width: 100%; margin-bottom: 5px;">Settings</button>
        <button onclick="window.location.href='Pcoin.html'" style="display: block; width: 100%; margin-bottom: 5px;">Top up balance Pcoin</button>
        <button onclick="window.location.href='riegist'" style="display: block; width: 100%;">Register or Login</button>
    </div>

    <div class="menuContainer" id="menuContainer" style="display: none;">
        <div class="appItem"><form action="results.html" method="get">
            <input type="text" name="query" placeholder="Enter your query" style="width: 70px ;height: 10px;" required>
            <button type="submit"style="height: 40px;width: 80px;">Search</button>
        </form></div>
        <div class="appItem" onclick="openApp('PerrotSoft-Play')">
            <i class="fab fa-google-play appIcon"></i>
            <span>Play</span>
        </div>
        <div class="appItem" onclick="openApp('https://perrotsoft.github.io/')">
            <img src="img/Home.png" alt="png">
            <span>Home</span>
        </div>
        <div class="appItem" onclick="openApp('Install_PerrotOS')">
            <img src="img/ico1.png" alt="png">
            <span>install OS</span>
        </div>
        <div class="appItem" onclick="openApp('datapedia')">
          <img src="img/datapedia icon1.png" alt="png">
          <span>dataPedia</span>
      </div>
    <div class="appItem" onclick="openApp('https://wavychatapp.github.io/')">
        <img src="https://wavychatapp.github.io/WavyChatApp.ico" width="30px" height="30px" alt="png">
        <span>WavyChatApp</span>
    </div>
        <div class="appItem" onclick="openApp('accunt')">
            <img src="img/as.png" alt="png">
            <span>Account settings.</span>
        </div>
    </div>
    
    <nav id="settingsNav">
        </nav>

    <div class="main-content" id="mainContent">
        <h1>Welcome to Account Settings</h1>
        <p>Please select a section from the left menu to manage your account.</p>
    </div>
    
    <script>
        let uid;
        let currentField = 'Profile'; 
        const name = getCookie('name');
        const email = getCookie('email');
        const pcoin = "Pcoin " + (getCookie('p-coin') || '0');
        const icon = getCookie('icon') || "https://cdn-icons-png.flaticon.com/128/17807/17807725.png";
        
        // Массив/объект настроек для навигации
        const settingsSections = {
            'Profile': {
                title: 'Profile Info',
                html: `
                    <div class="settings-container">
                        <h2>Profile Information</h2>
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                            <img class="user-icn1" src="${icon}" alt="User Icon" id="profileIcon">
                            <div>
                                <div style="font-size: 24px; font-weight: bold;" id="profileName">${name || "No Name"}</div>
                                <div style="font-size: 16px; color: gray;" id="profileEmail">${email || "No Email"}</div>
                                <div style="font-size: 16px; color: green;" id="profilePcoin">${pcoin || "Pcoin 0"}</div>
                            </div>
                        </div>
                        <hr>
                        </div>
                `
            },
            'Login': {
                title: 'Change Login',
                html: `
                    <div class="settings-container">
                        <h2>Change Login</h2>
                        <label>Current Login: <strong>${name || "No Name"}</strong></label>
                        <label>New Login</label>
                        <input type="text" id="loginInput" class="ggg" placeholder="Enter new login">
                        <button class="button" onclick="confirmChange('Login')">Confirm Change</button>
                        <div class="note" style="margin-top: 10px;">A confirmation message will be sent to change your login.</div>
                    </div>
                `
            },
            'Password': {
                title: 'Change Password',
                html: `
                    <div class="settings-container">
                        <h2>Change Password</h2>
                        <label>New Password</label>
                        <input type="password" id="passwordInput" class="ggg" placeholder="Enter new password">
                        <button class="button" onclick="confirmChange('Password')">Confirm Change</button>
                    </div>
                `
            },
            'Icon': {
                title: 'Change Account Icon',
                html: `
                    <div class="settings-container">
                        <h2>Change Account Icon</h2>
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                            <img id="iconPreview" class="user-icn1" src="${icon}" alt="Icon Preview">
                            <span style="font-weight: bold;">Preview</span>
                        </div>

                        <label>Enter new icon URL (Link)</label>
                        <input type="text" id="iconUrlInput" class="ggg" placeholder="New icon URL" oninput="document.getElementById('iconPreview').src = this.value || '${icon}'">

                        <label>OR upload file (will be converted to Base64)</label>
                        <input type="file" id="iconFileInput" accept="image/*" onchange="fileToBase64(this, 'iconUrlInput', 'iconPreview')">

                        <button class="button" onclick="confirmChange('Icon')">Save Icon</button>
                    </div>
                `
            },
            'Delete': {
                title: 'Delete Account',
                html: `
                    <div class="settings-container">
                        <h2 style="color: red;">Delete Account</h2>
                        <p>This action is irreversible. Please enter your password to confirm account deletion.</p>
                        <label>Password</label>
                        <input type="password" id="deletePasswordInput" class="ggg" placeholder="Enter your password">
                        <button class="button" style="background-color: red;" onclick="confirmChange('DelAcu')">Delete Account</button>
                    </div>
                `
            }
        };

        // Новая структура данных для кластеризованной навигации
        const navClusters = [
            {
                title: 'ACCOUNT SETTINGS',
                id: 'account',
                items: [
                    { id: 'Profile', title: 'Profile Info', type: 'section' },
                    { id: 'Login', title: 'Change Login', type: 'section' },
                    { id: 'Password', title: 'Change Password', type: 'section' },
                    { id: 'Icon', title: 'Change Account Icon', type: 'section' },
                    { id: 'Delete', title: 'Delete Account', type: 'section' }, 
                ]
            },
            {
                title: 'FINANCIAL',
                id: 'financial',
                items: [
                    { id: 'Wallet', title: 'P-coin Wallet', type: 'link', url: 'Pcoin.html' },
                ]
            },
            {
                title: 'TOOLS',
                id: 'tools',
                items: [
                    { id: 'Developer', title: 'Developer Menu', type: 'link', url: 'Dvelopent.html' },
                ]
            }
        ];

        // --- Инициализация и навигация ---

        (async function() {
            // Убедитесь, что userID и getCookie доступны из js/user.js
            try {
                uid = await userID(getCookie('name'));
                console.log("User ID:", uid);
            } catch (e) {
                console.error("Error fetching UID or user.js not loaded:", e);
            }
            updateSettingsList(); 
            showSettingsSection('Profile'); 
        })();

        // Обновление списка настроек в сайдбаре
        function updateSettingsList() {
            const nav = document.getElementById('settingsNav');
            nav.innerHTML = '';
            
            navClusters.forEach((cluster, clusterIndex) => {
                // Добавление разделителя перед заголовком кластера (кроме первого)
                if (clusterIndex > 0) {
                     const separator = document.createElement('hr');
                     separator.className = 'cluster-separator';
                     nav.appendChild(separator);
                }
                
                // Добавление Заголовка Кластера
                const titleDiv = document.createElement('div');
                titleDiv.className = 'cluster-title';
                titleDiv.textContent = cluster.title;
                nav.appendChild(titleDiv);

                // Добавление элементов кластера
                cluster.items.forEach(item => {
                    const link = document.createElement('a');
                    link.textContent = item.title;
                    
                    if (item.type === 'section') {
                        link.href = '#';
                        link.setAttribute('data-section', item.id);
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            showSettingsSection(item.id);
                            if (window.innerWidth <= 768) {
                                document.getElementById('settingsNav').classList.remove('active');
                            }
                        });
                    } else if (item.type === 'link') {
                        link.href = item.url;
                    }

                    nav.appendChild(link);
                });
            });
        }

        // Отображение выбранного раздела настроек
        function showSettingsSection(sectionId) {
            currentField = sectionId;
            const mainContent = document.getElementById('mainContent');
            const navLinks = document.querySelectorAll('#settingsNav a[data-section]');

            // Сброс активного класса и установка нового
            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('data-section') === sectionId);
            });

            // Отображение контента
            mainContent.innerHTML = settingsSections[sectionId].html;

            // Обновление предпросмотра иконок после загрузки секции, где это необходимо
            if (sectionId === 'Icon') {
                 document.getElementById('iconPreview').src = getCookie('icon') || "https://cdn-icons-png.flaticon.com/128/17807/17807725.png";
            }
        }
        
        // --- Логика конвертации Base64 ---
        
        function fileToBase64(fileInput, targetInputId, previewId) {
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = function() {
                const base64String = reader.result;
                document.getElementById(targetInputId).value = base64String;
                document.getElementById(previewId).src = base64String;
            };
            reader.onerror = function(error) {
                console.error("Error reading file:", error);
                alert("Error reading file for Base64 conversion.");
            };
            reader.readAsDataURL(file);
        }

        // --- Функции, адаптированные из оригинального кода ---

        // Переключение меню приложений (вверху)
        function toggleMenu() {
            const menuContainer = document.getElementById('menuContainer');
            menuContainer.style.display = (menuContainer.style.display === 'block') ? 'none' : 'block';
        }
        
        // Переключение меню пользователя (вверху справа)
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            // Проверяем, видимо ли мобильное меню, и закрываем его, если оно открыто
            const isNavOpen = document.getElementById('settingsNav').classList.contains('active');
            if (isNavOpen) {
                document.getElementById('settingsNav').classList.remove('active');
            }
            userMenu.style.display = (userMenu.style.display === 'block') ? 'none' : 'block';
        }

        // Переключение бокового меню настроек (только для мобильной версии)
        function toggleNavMenu() {
            const nav = document.getElementById('settingsNav');
            // Проверяем, видимо ли userMenu, и закрываем его, если оно открыто
            const isUserMenuOpen = document.getElementById('userMenu').style.display === 'block';
            if (isUserMenuOpen) {
                document.getElementById('userMenu').style.display = 'none';
            }
            nav.classList.toggle('active');
        }

        async function confirmChange(field) {
            let inputElement;
            let text;
            
            if (field === 'Password') {
                inputElement = document.getElementById('passwordInput');
                text = inputElement.value;
                const hash = await hashMessage(text);
                
                if (uid != null && !isNaN(uid) && uid >= 0 && hash != null) {
                    writeCell('C' + uid, hash);
                    alert('Password successfully changed');
                    inputElement.value = '';
                } else {
                    console.error('UID or hash value is invalid.');
                    alert('Error: Invalid UID or hash value.');
                }
            } else if (field === 'Login') {
                inputElement = document.getElementById('loginInput');
                text = inputElement.value;
                
                if (uid != null && !isNaN(uid) && uid >= 0) {
                    const currentLoginCheck = await userID(getCookie('name'));
                    if(currentLoginCheck === uid){
                        setCookie('name', text);
                        writeCell('A' + uid, text);
                        alert('Login successfully changed. Please refresh the page.');
                    } else {
                        alert('Error: Login is not the same as the current one or something went wrong.');
                    }
                } else {
                    console.error('UID or hash value is invalid.');
                    alert('Error: Invalid UID or hash value.');
                }
            } else if (field === 'Icon') {
                inputElement = document.getElementById('iconUrlInput');
                text = inputElement.value;

                if (uid != null && !isNaN(uid) && uid >= 0) {
                    setCookie('icon', text);
                    writeCell('E' + uid, text);
                    alert('Icon successfully changed');
                    document.querySelector('img.user-icn').src = text;
                } else {
                    console.error('UID is invalid.');
                    alert('Error: Invalid UID.');
                }
            } else if (field === 'DelAcu') {
                inputElement = document.getElementById('deletePasswordInput');
                text = inputElement.value;
                const hash = await hashMessage(text);
                
                if (uid != null && !isNaN(uid) && uid >= 0 && hash != null) {
                    const storedHash = await readCell('C' + uid); 
                    if(storedHash === hash){
                        writeCell('A' + uid, '');
                        alert("The account has been deleted");
                    } else {
                        alert("Error: Incorrect password.");
                    }
                } else {
                    console.error('UID or hash value is invalid.');
                    alert('Error: Invalid UID or hash value.');
                }
            }
            
            // Обновляем Profile UI после изменения
            if (field === 'Login' || field === 'Icon') {
                 showSettingsSection('Profile');
            }
        }
    </script>
</body>
</html>