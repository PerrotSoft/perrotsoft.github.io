<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="img/ico.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style1.css">
    <script src="js/sitefun.js" type="module"></script>
    <script src="js/user.js"></script>
    <style>
        /* General styles for the new layout */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1f1d1d; /* Will be overridden by JS */
            margin: 0;
            padding-top: 60px;
            display: flex;
            min-height: 100vh;
        }

        /* ------------------------------------- */
        /* Sidebar Menu - GitHub Style */
        /* ------------------------------------- */
        nav {
            background-color: #2b2c2e; /* Will be overridden by JS */
            width: 250px;
            min-width: 200px;
            padding: 10px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            position: fixed;
            height: 100%;
            color: #ffffff;
            overflow-y: auto;
            top: 0;
            left: 0;
            z-index: 99;
            box-sizing: border-box;
            padding-top: 70px;
        }

        /* Cluster Title */
        .cluster-title {
            color: #A9B2BB; /* Will be overridden by JS */
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 15px 15px 5px 15px;
            margin-top: 5px;
        }

        /* Separator line between clusters */
        .cluster-separator {
            border: none;
            height: 1px;
            background-color: #444C56; /* Will be overridden by JS */
            margin: 5px 15px;
        }

        /* Sidebar link style (static, will be overridden) */
        nav a {
            text-decoration: none;
            display: block;
            margin: 0;
            color: #C8D1D9; /* Will be overridden by JS */
            font-size: 15px;
            padding: 10px 15px;
            border-left: 3px solid transparent;
            transition: background-color 0.2s, border-left-color 0.2s, color 0.2s;
        }
        /* ------------------------------------- */

        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
            box-sizing: border-box;
        }

        /* Top User Panel (preserved) */
        .top-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #191919; /* Will be overridden by JS */
            color: white; /* Will be overridden by JS */
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Style for content inputs */
        .settings-container label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555; /* Will be overridden by JS */
        }
        .settings-container input[type="text"],
        .settings-container input[type="password"],
        .settings-container textarea {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: inherit; /* For correct display in dark theme */
            color: inherit; /* For correct display in dark theme */
        }
        .settings-container .button {
            display: inline-block;
            width: auto;
            min-width: 150px;
            margin-top: 20px;
            padding: 10px 20px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
        }
        .settings-container .button:hover {
            background: #0c5dc0;
        }

        .user-icn1 {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Override styles for mobile devices */
        @media (max-width: 768px) {
            body {
                padding-top: 50px;
                flex-direction: column;
            }
            .top-panel {
                height: 50px;
            }
            nav {
                position: absolute;
                left: 0;
                top: 0;
                width: 70vw;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s;
                padding-top: 50px;
            }
            nav.active {
                transform: translateX(0);
                box-shadow: 5px 0 10px rgba(0, 0, 0, 0.3);
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
                width: 100%;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>
<div class="tt">
        <button class="toggleButton" onclick="toggleMenu()">☰</button>
        <div class="user-widget" onclick="toggleUserMenu()">
            <img class="user-icn" src="https://cdn-icons-png.flaticon.com/128/17807/17807725.png" alt="Иконка профиля">
            <div class="user-widget-info">
                <div class="name">User Name</div>
                <div class="email"></div>
                <div class="pcoin">Pcoin 0</div>
            </div>
            </div>
            <div class="user-menu" id="userMenu" style="display: none;">
                <button onclick="window.location.href='accunt'">Setings</button>
                <button onclick="window.location.href='accunt'">top up balance Pcoin</button>
                <button onclick="window.location.href='riegist'">register or login</button>
            </div>
        <div class="menuContainer" id="menuContainer">
            <div class="appItem"><form action="results.html" method="get">
                <input type="text" name="query" placeholder="Enter your query" style="width: 70px ;height: 10px;" required>
                <button type="submit"style="height: 40px;width: 80px;">Search</button>
            </form></div>
            <div class="appItem" onclick="openApp('PerrotSoft-Play')">
                <i class="fab fa-google-play appIcon"></i>
                <span>Play</span>
            </div>
            <div class="appItem" onclick="openApp('https://perrotsoft.github.io/')">
                <img src="img/Home.png" alt="png">
                <span>Home</span>
            </div>
            <div class="appItem" onclick="openApp('Install_PerrotOS')">
                <img src="img/ico1.png" alt="png">
                <span>install OS</span>
            </div>
            <div class="appItem" onclick="openApp('datapedia')">
              <img src="img/datapedia icon1.png" alt="png">
              <span>dataPedia</span>
          </div>
        <div class="appItem" onclick="openApp('https://wavychatapp.github.io/')">
            <img src="https://wavychatapp.github.io/WavyChatApp.ico" width="30px" height="30px" alt="png">
            <span>WavyChatApp</span>
        </div>
            <div class="appItem" onclick="openApp('accunt')">
                <img src="img/as.png" alt="png">
                <span>Account settings.</span>
            </div>
            <div class="appItem" onclick="openApp('ParrotSoft_Apps')">
            <img src="img/Apps.png" width="30px" height="30px" alt="png">
            <span>ParrotSoft Apps</span>
        </div>
        </div>
        <nav id="settingsNav">
        </nav>

    <div class="main-content" id="mainContent">
        <h1>Welcome to Account Settings</h1>
        <p>Please select a section from the left menu to manage your account.</p>
    </div>
    </div>
    </div>
    <script>
        let uid;
        let currentField = 'Styling'; 
        const name = getCookie('name');
        const email = getCookie('email');
        const pcoin = "Pcoin " + (getCookie('p-coin') || '0');
        const icon = getCookie('icon') || "https://cdn-icons-png.flaticon.com/128/17807/17807725.png";

        // --- Styles table for themes ---
        const themeStyles = {
            'dark': {
                'toggleButton-bg':'#1f1d1d',
                'body-bg': '#1f1d1d', 'text-color': '#FFFFFF',
                'top-panel-bg': '#191919', 'top-panel-color': '#FFFFFF',
                'nav-bg': '#2b2c2e', 'nav-text': '#FFFFFF',
                'nav-hover': '#444C56', 'nav-active-bg': '#3C444B',
                'cluster-title': '#FFFFFF', 'input-color': '#DDDDDD',
                'main-content-h2': '#FFFFFF', 'link-accent': '#0366D6',
            },
            'white': {
                'body-bg': '#FFFFFF', 'text-color': '#333333',
                'top-panel-bg': '#FFFFFF', 'top-panel-color': '#333333',
                'nav-bg': '#FFFFFF', 'nav-text': '#333333',
                'nav-hover': '#F0F0F0', 'nav-active-bg': '#E0E0E0',
                'cluster-title': '#888888', 'input-color': '#333',
                'main-content-h2': '#000', 'link-accent': '#007bff',
            },
            'gray': {
                'body-bg': '#CCCCCC', 'text-color': '#111111',
                'top-panel-bg': '#3C444B', 'top-panel-color': '#EBEBEB',
                'nav-bg': '#555C66', 'nav-text': '#EBEBEB',
                'nav-hover': '#6E7985', 'nav-active-bg': '#505760',
                'cluster-title': '#C0C8D0', 'input-color': '#333',
                'main-content-h2': '#222', 'link-accent': '#00BFFF',
            }
        };

        // --- Theme application logic ---
        function applyTheme(themeName) {
            const theme = themeStyles[themeName];
            if (!theme) return;

            // Apply main styles
            document.body.style.backgroundColor = theme['body-bg'];
            document.body.style.color = theme['text-color'];
            
            // Top Panel
            const topPanel = document.querySelector('.top-panel');
            if (topPanel) {
                topPanel.style.backgroundColor = theme['top-panel-bg'];
                topPanel.style.color = theme['top-panel-color'];
            }
            // Sidebar Navigation
            const nav3123 = document.querySelector('.user-widget');
            if (nav3123) {
                nav3123.style.color = '#333333';
            }
            const nav31231 = document.querySelector('appItem');
            if (nav31231) {
                nav31231.style.color = '#000000';
            }
            const nav = document.getElementById('settingsNav');
            if (nav) {
                nav.style.backgroundColor = theme['nav-bg'];
            }

            // Dynamic CSS override for hovers, active links, and colors
            let styleSheet = document.getElementById('theme-style');
            if (!styleSheet) {
                styleSheet = document.createElement('style');
                styleSheet.id = 'theme-style';
                document.head.appendChild(styleSheet);
            }
            styleSheet.textContent = `
                /* Dynamic Theme Overrides for ${themeName} */
                .main-content h1, .main-content h2, .settings-container label { color: ${theme['input-color']} !important; }
                .settings-container h2 { color: ${theme['main-content-h2']}; }
                .main-content { background-color: ${theme['body-bg']} !important; }

                /* Nav Links & Titles */
                nav a { color: ${theme['nav-text']} !important; border-left-color: transparent !important; }
                nav a:hover { background-color: ${theme['nav-hover']} !important; color: ${theme['top-panel-color']} !important; }
                nav a.active { background-color: ${theme['nav-active-bg']} !important; border-left-color: ${theme['link-accent']} !important; color: ${theme['top-panel-color']} !important; }
                .cluster-separator { background-color: ${theme['nav-hover']} !important; }
                .cluster-title { color: ${theme['cluster-title']} !important; }

                /* Inputs */
                .settings-container input[type="text"], 
                .settings-container input[type="password"], 
                .settings-container textarea { 
                    color: ${theme['text-color']}; 
                    background-color: ${theme['body-bg']}; 
                    border-color: ${theme['cluster-title']};
                }

                /* Ensure top panel text color */
                .top-panel div[style*="font-weight: bold;"] { color: ${theme['top-panel-color']} !important; }
            `;

            // Updating icon color in user-menu (assuming they are SVG or PNG)
            document.querySelectorAll('.user-menu button').forEach(btn => {
                btn.style.color = theme['text-color'];
                btn.style.backgroundColor = theme['body-bg'];
            });
            const userMenu = document.getElementById('userMenu');
            if (userMenu) {
                userMenu.style.backgroundColor = theme['body-bg'];
                userMenu.style.borderColor = theme['nav-hover'];
            }
        }

        function selectTheme(themeName) {
            if (themeStyles[themeName]) {
                applyTheme(themeName);
                // Saving theme to Cookie for 30 days
                setCookie('theme', themeName, 30); 
            }
        }
        
        // --- Content settings by cluster ---
        const settingsSections = {
            'Styling': {
                title: 'Account Styling',
                html: `
                    <div class="settings-container">
                        <h2>Account Styling</h2>
                        
                        <h3>General Information</h3>
                        <label>Username (Login)</label>
                        <input type="text" id="loginInput" class="ggg" placeholder="Enter new login" value="${name || "No Name"}">

                        <h3 style="margin-top: 30px;">Account Image</h3>
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                            <img id="iconPreview" class="user-icn1" src="${icon}" alt="Icon Preview">
                            <span style="font-weight: bold;">Preview</span>
                        </div>
                        <label>Icon URL (Link)</label>
                        <input type="text" id="iconUrlInput" class="ggg" placeholder="New icon URL" oninput="document.getElementById('iconPreview').src = this.value || '${icon}'" value="${icon}">

                        <label>OR File Upload (Convert to Base64)</label>
                        <input type="file" id="iconFileInput" accept="image/*" onchange="fileToBase64(this, 'iconUrlInput', 'iconPreview')">

                        <div style="margin-top: 20px;">
                            <button class="button" onclick="confirmChange('Styling')">Save Styling</button>
                        </div>
                        <div class="note" style="margin-top: 10px;">Saves Name, Description, and Image.</div>
                    </div>
                `
            },
            'Theme': {
                title: 'Design Theme',
                html: `
                    <div class="settings-container">
                        <h2>Design Theme</h2>
                        <p>Select one of the available themes. Changes are automatically saved in a Cookie.</p>

                        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                            <label style="font-weight: normal; cursor: pointer;">
                                <input type="radio" name="themeSelector" value="dark" onclick="selectTheme('dark')">
                                <span style="margin-left: 5px;">Dark</span>
                            </label>
                            <label style="font-weight: normal; cursor: pointer;">
                                <input type="radio" name="themeSelector" value="white" onclick="selectTheme('white')">
                                <span style="margin-left: 5px;">White</span>
                            </label>
                            <label style="font-weight: normal; cursor: pointer;">
                                <input type="radio" name="themeSelector" value="gray" onclick="selectTheme('gray')">
                                <span style="margin-left: 5px;">Gray</span>
                            </label>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button class="button" onclick="alert('The theme is saved automatically in a Cookie upon selection.')" style="min-width: auto; background-color: #6c757d;">
                                Save
                            </button>
                        </div>
                    </div>
                `
            },
            'Security': {
                title: 'Password and Security',
                html: `
                    <div class="settings-container">
                        <h2>Password and Security</h2>
                        
                        <h3>Change Password</h3>
                        <label>New Password</label>
                        <input type="password" id="passwordInput" class="ggg" placeholder="Enter new password">
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="button" onclick="confirmChange('Password')" style="flex-grow: 1; background-color: #0366D6; font-size: 16px; min-width: auto;">Change Password</button>
                            <button class="button" onclick="alert('The password recovery button is not active yet. You need to wait.')" style="flex-grow: 1; background-color: #555; font-size: 16px; min-width: auto;">Recover Password</button>
                        </div>
                        <div class="note" style="margin-top: 10px;">The Recover Password button is not active yet.</div>
                    </div>
                `
            },
            'Deletion': {
                title: 'Delete Account',
                html: `
                    <div class="settings-container">
                        <h2 style="color: red;">Delete Account</h2>
                        <p>Warning! This action is irreversible and will lead to the deletion of all your data.</p>
                        <label>Enter your password to confirm deletion</label>
                        <input type="password" id="deletePasswordInput" class="ggg" placeholder="Enter your password">
                        <button class="button" style="background-color: red;" onclick="confirmChange('DelAcu')">Delete Account Permanently</button>
                    </div>
                `
            }
        };

        // --- Navigation cluster structure ---
        const navClusters = [
            {
                title: 'ACCOUNT',
                id: 'account',
                items: [
                    { id: 'Styling', title: 'Account Styling', type: 'section' },
                    { id: 'Theme', title: 'Design Theme', type: 'section' }, // <-- New cluster
                    { id: 'Security', title: 'Password and Security', type: 'section' },
                    { id: 'Deletion', title: 'Delete Account', type: 'section' }, 
                ]
            },
            {
                title: 'FINANCES',
                id: 'financial',
                items: [
                    { id: 'Wallet', title: 'P-coin Wallet', type: 'link', url: 'Pcoin.html' },
                ]
            },
            {
                title: 'TOOLS',
                id: 'tools',
                items: [
                    { id: 'Developer', title: 'Developer Menu', type: 'link', url: 'Dvelopent.html' },
                ]
            }
        ];

        // --- Initialization and Navigation ---

        (async function() {
            // Apply theme from Cookie first
            const savedTheme = getCookie('theme') || 'dark';
            applyTheme(savedTheme);

            try {
                uid = await userID(getCookie('name'));
                console.log("User ID:", uid);
            } catch (e) {
                console.error("Error fetching UID or user.js not loaded:", e);
            }
            updateSettingsList(); 
            showSettingsSection('Styling'); // Show styling by default
        })();

        // Update settings list in sidebar
        function updateSettingsList() {
            const nav = document.getElementById('settingsNav');
            nav.innerHTML = '';
            
            navClusters.forEach((cluster, clusterIndex) => {
                if (clusterIndex > 0) {
                     const separator = document.createElement('hr');
                     separator.className = 'cluster-separator';
                     nav.appendChild(separator);
                }
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'cluster-title';
                titleDiv.textContent = cluster.title;
                nav.appendChild(titleDiv);

                cluster.items.forEach(item => {
                    const link = document.createElement('a');
                    link.textContent = item.title;
                    
                    if (item.type === 'section') {
                        link.href = '#';
                        link.setAttribute('data-section', item.id);
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            showSettingsSection(item.id);
                            if (window.innerWidth <= 768) {
                                document.getElementById('settingsNav').classList.remove('active');
                            }
                        });
                    } else if (item.type === 'link') {
                        link.href = item.url;
                    }

                    nav.appendChild(link);
                });
            });
            // Re-apply cluster title styles after creation
            applyTheme(getCookie('theme') || 'dark');
        }

        // Display selected settings section
        function showSettingsSection(sectionId) {
            currentField = sectionId;
            const mainContent = document.getElementById('mainContent');
            const navLinks = document.querySelectorAll('#settingsNav a[data-section]');

            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('data-section') === sectionId);
            });

            mainContent.innerHTML = settingsSections[sectionId].html;
            applyTheme(getCookie('theme') || 'dark'); // Re-apply theme so content styles update

            // Update specific elements after loading
            if (sectionId === 'Styling') {
                 document.getElementById('iconPreview').src = getCookie('icon') || "https://cdn-icons-png.flaticon.com/128/17807/17807725.png";
                 document.getElementById('iconUrlInput').value = getCookie('icon') || '';
                 document.getElementById('loginInput').value = getCookie('name') || '';
            } else if (sectionId === 'Theme') {
                 // Set the active radio button
                 const savedTheme = getCookie('theme') || 'dark';
                 const radio = document.querySelector(`input[name="themeSelector"][value="${savedTheme}"]`);
                 if (radio) {
                     radio.checked = true;
                 }
            }
        }
        
        // --- Base64 conversion logic ---
        
        function fileToBase64(fileInput, targetInputId, previewId) {
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = function() {
                const base64String = reader.result;
                document.getElementById(targetInputId).value = base64String;
                document.getElementById(previewId).src = base64String;
            };
            reader.onerror = function(error) {
                console.error("Error reading file:", error);
                alert("Error reading file for Base64 conversion.");
            };
            reader.readAsDataURL(file);
        }

        // --- UI Management ---
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            const isNavOpen = document.getElementById('settingsNav').classList.contains('active');
            if (isNavOpen) {
                document.getElementById('settingsNav').classList.remove('active');
            }
            userMenu.style.display = (userMenu.style.display === 'block') ? 'none' : 'block';
        }

        function toggleNavMenu() {
            const nav = document.getElementById('settingsNav');
            const isUserMenuOpen = document.getElementById('userMenu').style.display === 'block';
            if (isUserMenuOpen) {
                document.getElementById('userMenu').style.display = 'none';
            }
            nav.classList.toggle('active');
        }

        // --- Main save logic ---
        async function confirmChange(field) {
            if (uid === null || isNaN(uid) || uid < 0) {
                alert('Error: User is not authorized or UID is invalid.');
                return;
            }

            if (field === 'Styling') {
                const newLogin = document.getElementById('loginInput').value;
                const newDescription="";const ff = document.getElementById('descriptionInput');
                if(ff){
                    newDescription = ff.value;
                }
                const newIcon = document.getElementById('iconUrlInput').value;

                let alertMessage = "Save Results:\n";
                let changed = false;

                // Update Login
                if (newLogin && newLogin !== getCookie('name')) {
                    const currentLoginCheck = await userID(getCookie('name'));
                    if(currentLoginCheck === uid){ 
                        setCookie('name', newLogin);
                        writeCell('A' + uid, newLogin);
                        alertMessage += " - Login successfully changed.\n";
                        changed = true;
                    } else {
                        alertMessage += " - Error changing login.\n";
                    }
                } else if (newLogin === getCookie('name')) {
                     alertMessage += " - Login did not change.\n";
                }

                // Update Icon
                if (newIcon && newIcon !== getCookie('icon')) {
                    setCookie('icon', newIcon);
                    writeCell('E' + uid, newIcon);
                    document.querySelector('img.user-icn').src = newIcon;
                    alertMessage += " - Icon successfully changed.\n";
                    changed = true;
                } else if (newIcon === getCookie('icon')) {
                    alertMessage += " - Icon did not change.\n";
                }
                
                alertMessage += ` - Description: "${newDescription}" (not saved to DB).\n`;
                
                alert(alertMessage);
                showSettingsSection('Styling');

            } else if (field === 'Password') {
                const text = document.getElementById('passwordInput').value;
                if (!text) { alert('Enter new password.'); return; }

                const hash = await hashMessage(text);
                
                if (hash != null) {
                    writeCell('C' + uid, hash);
                    alert('Password successfully changed');
                    document.getElementById('passwordInput').value = '';
                } else {
                    alert('Error: Failed to generate password hash.');
                }
            } else if (field === 'DelAcu') {
                const text = document.getElementById('deletePasswordInput').value;
                if (!text) { alert('Enter your password to confirm deletion.'); return; }
                
                const hash = await hashMessage(text);
                
                if (hash != null) {
                    const storedHash = await readCell('C' + uid); 
                    if(storedHash === hash){
                        writeCell('A' + uid, '');
                        alert("Account deleted");
                    } else {
                        alert("Error: Incorrect password.");
                    }
                } else {
                    alert('Error checking password.');
                }
            }
        }
    </script>
</body>
</html>