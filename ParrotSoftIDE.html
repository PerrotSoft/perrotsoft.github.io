<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParrotIDE</title>
    <style>
        /* Общие стили */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background-color: #1e1e1e;
            color: #CCCCCC;
        }

        /* Верхнее меню (для вида) */
        #top-menu {
            background-color: #3c3c3c;
            padding: 4px 10px;
            display: flex;
            gap: 15px;
            font-size: 13px;
            border-bottom: 1px solid #252526;
            flex-shrink: 0;
            position: relative; /* Для позиционирования выпадающего меню */
        }
        .menu-item {
            cursor: pointer;
            padding: 2px 0;
            transition: background-color 0.1s;
            position: relative; /* Для выпадающих подменю */
        }
        .menu-item:hover {
            background-color: #4a4a4a;
        }

        /* Выпадающее меню */
        .dropdown-menu {
            position: absolute;
            background-color: #252526;
            border: 1px solid #007acc;
            padding: 5px 0;
            z-index: 100;
            min-width: 150px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: none; /* Скрыто по умолчанию */
            top: 100%; /* Позиционирование под родительским пунктом меню */
            left: 0;
        }
        .dropdown-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.1s;
            white-space: nowrap;
        }
        .dropdown-menu-item:hover {
            background-color: #007acc;
        }

        /* Основная рабочая область */
        #main-area {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        /* Панель активности (слева) */
        #activity-bar {
            width: 50px;
            background-color: #333333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            border-right: 1px solid #252526;
            flex-shrink: 0;
        }
        .activity-icon {
            font-size: 24px;
            margin-bottom: 15px;
            color: #CCCCCC;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s, color 0.2s;
        }
        .activity-icon:hover {
            opacity: 1;
            color: white;
        }
        .activity-icon.active {
            color: #007acc;
            opacity: 1;
        }

        /* Боковая панель */
        #sidebar {
            width: 250px;
            background-color: #252526;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            border-right: 1px solid #3c3c3c;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        #sidebar-header {
            font-size: 14px;
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .file-item, .folder-item {
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 2px;
            transition: background-color 0.1s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-item:hover, .folder-item:hover {
            background-color: #3a3a3a;
        }
        .file-item.active {
            background-color: #007acc;
            color: white;
        }
        .folder-item {
            font-weight: bold;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .folder-item .folder-toggle {
            margin-right: 5px;
            color: #888;
        }
        .folder-item.expanded .folder-toggle .fa-chevron-right {
            transform: rotate(90deg);
        }
        .folder-contents {
            margin-left: 15px; /* Отступ для вложенных файлов/папок */
            border-left: 1px solid rgba(204, 204, 204, 0.2); /* Линия, имитирующая структуру */
            padding-left: 5px;
        }

        /* Область редактора и панели */
        #editor-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Верхняя панель редактора (вкладки и кнопки) */
        #editor-top-bar {
            background-color: #2d2d2d;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
            border-bottom: 1px solid #3c3c3c;
            flex-shrink: 0;
        }
        #file-tabs {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .file-tab {
            background-color: #1e1e1e;
            padding: 5px 10px;
            border-radius: 3px 3px 0 0;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid transparent;
            border-bottom: none;
            transition: background-color 0.1s;
        }
        .file-tab:hover {
             background-color: #3a3a3a;
        }
        .file-tab.active {
            background-color: #1e1e1e;
            border-color: #007acc;
            position: relative;
            z-index: 1;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        }
        .file-tab .close-tab-btn {
            background: none;
            border: none;
            color: #CCCCCC;
            font-size: 16px;
            cursor: pointer;
            padding: 0 3px;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .file-tab .close-tab-btn:hover {
            opacity: 1;
            color: white;
        }
        #editor-controls button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
            margin-left: 10px;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        #editor-controls button:hover {
            background-color: #005f9c;
        }

        /* Контейнер для редактора */
        #editor-container {
            flex-grow: 1;
        }

        /* Панель вывода */
        #panel {
            height: 180px;
            background-color: #1e1e1e;
            color: #CCCCCC;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            border-top: 1px solid #3c3c3c;
            flex-shrink: 0;
        }
        #panel-tabs {
            display: flex;
            border-bottom: 1px solid #3c3c3c;
            margin-bottom: 10px;
        }
        .panel-tab {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 2px solid transparent;
            transition: border-bottom 0.2s;
        }
        .panel-tab.active {
            border-bottom-color: #007acc;
        }
        #output-console {
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
        }

        /* Статус-бар */
        #status-bar {
            background-color: #007acc;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .status-item {
            margin-right: 15px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div id="top-menu">
        <div class="menu-item" id="file-menu-item">Файл
            <div class="dropdown-menu" id="file-dropdown">
                <div class="dropdown-menu-item" id="new-file-option">Новый файл</div>
                <div class="dropdown-menu-item" id="open-file-option">Открыть файл...</div>
                <div class="dropdown-menu-item" id="open-folder-option">Открыть папку (имитация)</div>
                <hr style="border-color: #3c3c3c; margin: 5px 0;">
                <div class="dropdown-menu-item" id="save-as-option">Сохранить как...</div>
            </div>
        </div>
        <div class="menu-item">Правка</div>
        <div class="menu-item">Выделение</div>
        <div class="menu-item">Вид</div>
        <div class="menu-item">Перейти</div>
        <div class="menu-item">Выполнить</div>
        <div class="menu-item">Терминал</div>
        <div class="menu-item">Справка</div>
    </div>

    <div id="main-area">
        <div id="activity-bar">
            <div class="activity-icon active" data-panel="explorer" title="Проводник"><i class="fas fa-files"></i></div>
            <div class="activity-icon" data-panel="search" title="Поиск"><i class="fas fa-search"></i></div>
            <div class="activity-icon" data-panel="source-control" title="Система управления версиями"><i class="fas fa-code-branch"></i></div>
            <div class="activity-icon" data-panel="debug" title="Запуск и отладка"><i class="fas fa-bug"></i></div>
            <div class="activity-icon" data-panel="extensions" title="Расширения"><i class="fas fa-puzzle-piece"></i></div>
        </div>

        <div id="sidebar">
            <div id="sidebar-header">Проводник</div>
            <div id="file-tree">
                </div>
        </div>

        <div id="editor-area">
            <div id="editor-top-bar">
                <div id="file-tabs">
                    </div>
                <div id="editor-controls">
                    <span style="margin-right: 10px;">Язык: <span id="current-language"></span></span>
                    <button id="run-button">Запустить код</button>
                </div>
            </div>
            <div id="editor-container">
                </div>
            <div id="panel">
                <div id="panel-tabs">
                    <div class="panel-tab active" data-panel-content="output">Вывод</div>
                    <div class="panel-tab" data-panel-content="problems">Проблемы</div>
                    <div class="panel-tab" data-panel-content="terminal">Терминал</div>
                </div>
                <pre id="output-console"></pre>
            </div>
        </div>
    </div>

    <div id="status-bar">
        <div class="status-item">Строка: <span id="status-line">1</span>, Столбец: <span id="status-col">1</span></div>
        <div class="status-item">LF</div>
        <div class="status-item">UTF-8</div>
        <div class="status-item"><span id="status-language"></span></div>
        <div class="status-item">ParrotIDE</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.48.0/min/vs/loader.js"></script>

    <script>
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.48.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            let editor;
            const outputConsole = document.getElementById('output-console');
            const runButton = document.getElementById('run-button');
            const fileTree = document.getElementById('file-tree');
            const currentLanguageSpan = document.getElementById('current-language');
            const fileTabsContainer = document.getElementById('file-tabs');
            const statusBarLine = document.getElementById('status-line');
            const statusBarCol = document.getElementById('status-col');
            const statusBarLanguage = document.getElementById('status-language');
            const panelTabs = document.getElementById('panel-tabs');

            // File Menu elements
            const fileMenuItem = document.getElementById('file-menu-item');
            const fileDropdown = document.getElementById('file-dropdown');
            const newFileOption = document.getElementById('new-file-option');
            const openFileOption = document.getElementById('open-file-option');
            const openFolderOption = document.getElementById('open-folder-option');
            const saveAsOption = document.getElementById('save-as-option');


            const files = {}; // Объект для хранения файлов: { id: { name, content, language, model, path } }
            let fileCounter = 0; // Для генерации уникальных ID
            let currentFileId = null; // ID текущего активного файла
            const folderStructure = {}; // Для имитации иерархии папок

            // --- Icon Mapping ---
            function getFileIcon(fileName) {
                const parts = fileName.split('.');
                const ext = parts[parts.length - 1];
                switch (ext) {
                    case 'js': return '<i class="fab fa-js"></i>';
                    case 'html': return '<i class="fab fa-html5"></i>';
                    case 'css': return '<i class="fab fa-css3-alt"></i>';
                    case 'json': return '<i class="fas fa-file-code"></i>';
                    case 'py': return '<i class="fab fa-python"></i>';
                    case 'c': return '<i class="fas fa-file-code"></i>';
                    case 'cpp': return '<i class="fas fa-file-code"></i>';
                    case 'cs': return '<i class="fas fa-file-code"></i>'; // C#
                    case 'java': return '<i class="fab fa-java"></i>';
                    case 'ts': return '<i class="fab fa-node-js"></i>'; // Using node-js for typescript
                    case 'md': return '<i class="fab fa-markdown"></i>';
                    case 'go': return '<i class="fab fa-go"></i>';
                    case 'rs': return '<i class="fab fa-rust"></i>';
                    case 'php': return '<i class="fab fa-php"></i>';
                    case 'rb': return '<i class="fas fa-gem"></i>';
                    case 'xml': return '<i class="fas fa-file-code"></i>';
                    case 'yaml': case 'yml': return '<i class="fas fa-file-alt"></i>';
                    case 'sh': return '<i class="fas fa-terminal"></i>';
                    case 'txt': return '<i class="fas fa-file-alt"></i>';
                    case 'wasm': return '<i class="fas fa-box"></i>'; // WebAssembly
                    case 'asm': return '<i class="fas fa-microchip"></i>'; // Assembly
                    case 'p#': return '<i class="fas fa-feather-alt"></i>'; // ParrotSharp, using a feather for "parrot"
                    default: return '<i class="fas fa-file"></i>'; // Generic file icon
                }
            }

            // Функция для определения языка по расширению файла
            function getLanguageByFileName(fileName) {
                const parts = fileName.split('.');
                const ext = parts[parts.length - 1].toLowerCase(); // Приводим к нижнему регистру для сравнения
                switch (ext) {
                    case 'js': return 'javascript';
                    case 'html': return 'html';
                    case 'css': return 'css';
                    case 'json': return 'json';
                    case 'py': return 'python';
                    case 'c': return 'c';
                    case 'cpp': return 'cpp';
                    case 'cs': return 'csharp';
                    case 'java': return 'java';
                    case 'ts': return 'typescript';
                    case 'md': return 'markdown';
                    case 'go': return 'go';
                    case 'rs': return 'rust';
                    case 'php': return 'php';
                    case 'rb': return 'ruby';
                    case 'xml': return 'xml';
                    case 'yaml':
                    case 'yml': return 'yaml';
                    case 'sh': return 'shell';
                    case 'wasm': return 'plaintext'; // Monaco doesn't have WASM language, use plaintext
                    case 'asm': return 'plaintext'; // Monaco might not have assembly, use plaintext
                    case 'p#': return 'plaintext'; // Custom language, use plaintext
                    case 'txt': return 'plaintext';
                    default: return 'plaintext';
                }
            }

            // Добавление файла в память и в UI
            function addFile(fullPath, content) {
                const id = 'file-' + fileCounter++;
                const pathParts = fullPath.split('/');
                const fileName = pathParts.pop();
                const language = getLanguageByFileName(fileName);
                const model = monaco.editor.createModel(content, language);

                files[id] = {
                    id: id,
                    name: fileName,
                    content: content,
                    language: language,
                    model: model,
                    path: fullPath
                };

                // Add to simulated folder structure
                let currentLevel = folderStructure;
                for (let i = 0; i < pathParts.length; i++) {
                    const part = pathParts[i];
                    if (!currentLevel[part]) {
                        currentLevel[part] = { __isFolder: true, __files: [], __subfolders: {} };
                    }
                    currentLevel = currentLevel[part].__subfolders;
                }
                if (!currentLevel.__files) currentLevel.__files = [];
                currentLevel.__files.push(id);

                return id;
            }

            // Clear all files and folder structure
            function clearAllFiles() {
                for (const id in files) {
                    files[id].model.dispose();
                }
                Object.keys(files).forEach(key => delete files[key]);
                Object.keys(folderStructure).forEach(key => delete folderStructure[key]); // Clear top-level
                fileCounter = 0;
                currentFileId = null;
                if (editor) {
                    editor.dispose();
                    editor = null;
                }
            }


            // Рендеринг дерева файлов в сайдбаре
            function renderFileTree() {
                fileTree.innerHTML = '';
                function renderLevel(container, level) {
                    const sortedKeys = Object.keys(level).sort((a, b) => {
                        const isAFolder = level[a].__isFolder;
                        const isBFolder = level[b].__isFolder;
                        if (isAFolder && !isBFolder) return -1; // Folders first
                        if (!isAFolder && isBFolder) return 1;
                        return a.localeCompare(b); // Alphabetical sort
                    });

                    sortedKeys.forEach(key => {
                        if (level[key].__isFolder) {
                            const folderId = 'folder-' + key.replace(/[^a-zA-Z0-9]/g, '-');
                            const folderItem = document.createElement('div');
                            folderItem.className = 'folder-item';
                            folderItem.dataset.folderId = folderId; // Assign a unique ID for expansion state
                            folderItem.innerHTML = `<span class="folder-toggle"><i class="fas fa-chevron-right"></i></span><i class="fas fa-folder"></i><span>${key}</span>`;
                            container.appendChild(folderItem);

                            const folderContentsDiv = document.createElement('div');
                            folderContentsDiv.className = 'folder-contents';
                            folderContentsDiv.style.display = 'none'; // Hidden by default
                            folderContentsDiv.dataset.folderContentOf = folderId; // Link to parent folder
                            container.appendChild(folderContentsDiv);

                            folderItem.addEventListener('click', (e) => {
                                if (e.target.closest('.folder-toggle')) { // Only toggle on icon click
                                    folderItem.classList.toggle('expanded');
                                    folderContentsDiv.style.display = folderItem.classList.contains('expanded') ? 'block' : 'none';
                                } else {
                                    // Optionally select folder, or do nothing.
                                    // For now, it doesn't "open" a folder in editor.
                                }
                            });

                            renderLevel(folderContentsDiv, level[key].__subfolders);

                            // Render files directly under this folder
                            if (level[key].__files) {
                                level[key].__files.forEach(fileId => {
                                    const fileItem = document.createElement('div');
                                    fileItem.className = 'file-item';
                                    fileItem.dataset.fileId = fileId;
                                    fileItem.innerHTML = `${getFileIcon(files[fileId].name)}<span>${files[fileId].name}</span>`;
                                    if (fileId === currentFileId) {
                                        fileItem.classList.add('active');
                                    }
                                    folderContentsDiv.appendChild(fileItem);
                                });
                            }
                        } else {
                            // This case should ideally not happen if __isFolder is correctly set
                            // But for standalone files at root, it would be handled here
                            // This part is mostly covered by the file listing within the folderContents above
                        }
                    });
                }
                renderLevel(fileTree, folderStructure);

                 // Render files directly at the root (not in any folder)
                 Object.values(files).filter(file => !file.path.includes('/')).forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.fileId = file.id;
                    fileItem.innerHTML = `${getFileIcon(file.name)}<span>${file.name}</span>`;
                    if (file.id === currentFileId) {
                        fileItem.classList.add('active');
                    }
                    fileTree.appendChild(fileItem);
                });
            }

            // Рендеринг вкладок файлов
            function renderFileTabs() {
                fileTabsContainer.innerHTML = '';
                for (const id in files) {
                    const tab = document.createElement('div');
                    tab.className = 'file-tab';
                    tab.dataset.fileId = id;
                    if (id === currentFileId) {
                        tab.classList.add('active');
                    }
                    tab.innerHTML = `${getFileIcon(files[id].name)}<span>${files[id].name}</span><button class="close-tab-btn" data-file-id="${id}">&times;</button>`;
                    fileTabsContainer.appendChild(tab);
                }
            }

            // Открытие файла в редакторе
            function openFile(fileId) {
                if (!files[fileId]) {
                    console.error('Файл не найден:', fileId);
                    return;
                }

                currentFileId = fileId;

                if (!editor) {
                    editor = monaco.editor.create(document.getElementById('editor-container'), {
                        model: files[fileId].model,
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        fontSize: 14,
                        lineNumbers: 'on',
                        scrollBeyondLastLine: false,
                        autoClosingBrackets: 'always',
                        autoClosingQuotes: 'always',
                        formatOnType: true,
                        formatOnPaste: true,
                    });

                    editor.onDidChangeCursorPosition((e) => {
                        statusBarLine.textContent = e.position.lineNumber;
                        statusBarCol.textContent = e.position.column;
                    });
                } else {
                    editor.setModel(files[fileId].model);
                }

                statusBarLanguage.textContent = files[fileId].language.charAt(0).toUpperCase() + files[fileId].language.slice(1);
                currentLanguageSpan.textContent = files[fileId].language;

                renderFileTree();
                renderFileTabs();
            }

            // Удаление файла
            function deleteFile(fileIdToDelete) {
                if (!files[fileIdToDelete]) return;

                const modelToDispose = files[fileIdToDelete].model;
                const filePath = files[fileIdToDelete].path;
                delete files[fileIdToDelete];

                if (modelToDispose) {
                    modelToDispose.dispose();
                }

                // Remove from folderStructure (simple removal for now, not cleaning empty folders)
                const pathParts = filePath.split('/');
                let currentLevel = folderStructure;
                for (let i = 0; i < pathParts.length - 1; i++) {
                    const part = pathParts[i];
                    if (currentLevel[part] && currentLevel[part].__subfolders) {
                        currentLevel = currentLevel[part].__subfolders;
                    } else {
                        currentLevel = null; // Path broken
                        break;
                    }
                }
                if (currentLevel && currentLevel.__files) {
                    const index = currentLevel.__files.indexOf(fileIdToDelete);
                    if (index > -1) {
                        currentLevel.__files.splice(index, 1);
                    }
                }


                if (currentFileId === fileIdToDelete) {
                    const remainingFileIds = Object.keys(files);
                    if (remainingFileIds.length > 0) {
                        openFile(remainingFileIds[0]);
                    } else {
                        if (editor) {
                            editor.dispose();
                            editor = null;
                        }
                        outputConsole.textContent = '';
                        currentLanguageSpan.textContent = '';
                        statusBarLanguage.textContent = '';
                        statusBarLine.textContent = '1';
                        statusBarCol.textContent = '1';
                        currentFileId = null;
                    }
                }
                renderFileTree();
                renderFileTabs();
            }

            // --- Real File Operations (via browser dialogs) ---

            // Function to open a file from the user's computer
            async function openLocalFile() {
                try {
                    const [fileHandle] = await window.showOpenFilePicker();
                    const file = await fileHandle.getFile();
                    const content = await file.text();

                    const newFileId = addFile(file.name, content); // Use file.name for path
                    openFile(newFileId);
                    outputConsole.textContent = `Файл "${file.name}" успешно открыт.`;
                } catch (err) {
                    if (err.name !== 'AbortError') { // User cancelled the dialog
                        outputConsole.textContent = `Ошибка при открытии файла: ${err.message}`;
                        console.error('Error opening file:', err);
                    } else {
                        outputConsole.textContent = `Открытие файла отменено.`;
                    }
                }
            }

            // Function to save the current file to the user's computer
            async function saveCurrentFileAs() {
                if (!currentFileId || !editor) {
                    outputConsole.textContent = 'Нет открытого файла для сохранения.';
                    return;
                }

                const currentFile = files[currentFileId];
                const content = editor.getValue();

                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: currentFile.name,
                        types: [{
                            description: `${currentFile.language.toUpperCase()} File`,
                            accept: {
                                [currentFile.language === 'plaintext' ? 'text/plain' : `text/${currentFile.language}`]: [`.${currentFile.name.split('.').pop()}`],
                            },
                        }],
                    });

                    const writableStream = await fileHandle.createWritable();
                    await writableStream.write(content);
                    await writableStream.close();

                    outputConsole.textContent = `Файл "${currentFile.name}" успешно сохранен.`;
                } catch (err) {
                    if (err.name !== 'AbortError') { // User cancelled the dialog
                        outputConsole.textContent = `Ошибка при сохранении файла: ${err.message}`;
                        console.error('Error saving file:', err);
                    } else {
                         outputConsole.textContent = `Сохранение файла отменено.`;
                    }
                }
            }


            // --- Simulated Folder Opening ---
            function openFolder() {

            }


            // Инициализация стартовых файлов
            const initialContents = {
                'README.md': `# Добро пожаловать в ParrotIDE!

Это ваша первая Web IDE, разработанная с помощью Monaco Editor и чистым JavaScript.

### Как использовать:
* **Новый файл:** Создайте пустой файл через меню "Файл".
* **Открыть файл...:** Загрузите файл с вашего компьютера.
* **Сохранить как...:** Сохраните текущий файл на ваш компьютер.
* **Пишите код:** Редактор поддерживает подсветку синтаксиса и автодополнение для многих языков.
* **Запускайте HTML/JavaScript/Python:** Нажмите "Запустить код" для выполнения.
* **Имитация для других языков:** Для C++, C#, WebAssembly, Assembly, P# и других языков вывод будет имитироваться, так как для реального выполнения нужен серверный бэкенд.

Приятного кодирования!`,
            };

            for (const fileName in initialContents) {
                addFile(fileName, initialContents[fileName]);
            }
            // Открываем первый файл из списка при старте
            openFile(Object.keys(files)[0]);


            // Обработчики событий
            // Клик по файлам в сайдбаре
            fileTree.addEventListener('click', (event) => {
                const fileId = event.target.dataset.fileId || event.target.closest('.file-item')?.dataset.fileId;
                if (fileId) {
                    openFile(fileId);
                }
            });

            // Клик по вкладкам файлов
            fileTabsContainer.addEventListener('click', (event) => {
                const target = event.target;
                const fileId = target.dataset.fileId || target.closest('.file-tab')?.dataset.fileId;

                if (target.classList.contains('close-tab-btn')) {
                    deleteFile(fileId);
                    event.stopPropagation();
                } else if (fileId) {
                    openFile(fileId);
                }
            });

            // Кнопка "Запустить код"
            runButton.addEventListener('click', () => {
                if (!currentFileId || !editor) {
                    outputConsole.textContent = 'Нет открытого файла для запуска.';
                    return;
                }

                const code = editor.getValue();
                const language = files[currentFileId].language;
                outputConsole.textContent = `Запускаю код на ${language.toUpperCase()}...\n\n`;

                if (language === 'javascript') {
                    try {
                        const originalLog = console.log;
                        let outputBuffer = '';
                        console.log = (...args) => {
                            outputBuffer += args.join(' ') + '\n';
                        };
                        eval(code);
                        console.log = originalLog; // Restore original console.log
                        outputConsole.textContent += outputBuffer;
                    } catch (e) {
                        outputConsole.textContent += `Ошибка выполнения JavaScript: ${e.message}\n`;
                    }
                } else if (language === 'html') {
                    outputConsole.textContent += `--- Открываю HTML в новом окне/вкладке ---\n`;
                    const newWindow = window.open();
                    newWindow.document.write(code);
                    newWindow.document.close();
                } else if (language === 'css') {
                    outputConsole.textContent += `--- CSS — это язык стилей, не может быть выполнен напрямую. Он применяется к HTML. ---\n`;
                } else if (language === 'python') {
                     outputConsole.textContent += `--- Имитация выполнения Python ---\n`;
                     // Simple Python execution imitation
                     if (code.includes('print(') || code.includes('console.log(')) {
                         const match = code.match(/print\s*\((.*?)\)|console\.log\s*\((.*?)\)/);
                         if (match) {
                             const content = match[1] || match[2];
                             outputConsole.textContent += `(Симулированный вывод из print/console.log): ${content.replace(/["']/g, '')}\n`;
                         }
                     }
                     outputConsole.textContent += `Для реального выполнения Python кода требуется серверный компонент или WebAssembly-интерпретатор.\n`;
                     outputConsole.textContent += `Вывод: "Python код успешно 'выполнен'!"\n`;
                } else if (language === 'csharp' || language === 'c' || language === 'cpp') {
                    outputConsole.textContent += `--- Имитация компиляции и выполнения ${language.toUpperCase()} ---\n`;
                    outputConsole.textContent += `Компиляция... (это симуляция)\n`;
                    outputConsole.textContent += `Cоздание исполняемого файла... (симуляция)\n`;
                    outputConsole.textContent += `Запуск... (симуляция)\n`;
                    outputConsole.textContent += `\nПривет из ${language.toUpperCase()}! (Симулированный вывод)\n`;
                    outputConsole.textContent += `Для реальной компиляции и выполнения ${language.toUpperCase()} необходим серверный компонент (бэкенд) с установленным компилятором.\n`;
                } else if (language === 'plaintext' && files[currentFileId].name.endsWith('.wasm')) {
                    outputConsole.textContent += `--- Имитация выполнения WebAssembly (.wasm) ---\n`;
                    outputConsole.textContent += `WebAssembly - это низкоуровневый бинарный формат. Для его запуска обычно требуется JavaScript-хост, который загружает и выполняет WASM-модуль.\n`;
                    outputConsole.textContent += `(Симулированный вывод: WebAssembly модуль готов к работе!)\n`;
                } else if (language === 'plaintext' && files[currentFileId].name.endsWith('.asm')) {
                    outputConsole.textContent += `--- Имитация выполнения Assembly (.asm) ---\n`;
                    outputConsole.textContent += `Код на Ассемблере очень низкоуровневый и специфичен для архитектуры процессора. Для его запуска нужна ассемблер-программа и прямой доступ к системе.\n`;
                    outputConsole.textContent += `(Симулированный вывод: Ассемблерный код 'скомпилирован' и 'запущен'.)\n`;
                } else if (language === 'plaintext' && files[currentFileId].name.endsWith('.p#')) {
                     outputConsole.textContent += `--- Имитация выполнения P# (ParrotSharp) ---\n`;
                     outputConsole.textContent += `Ваш уникальный язык P# 'компилируется' и 'запускается'!\n`;
                     outputConsole.textContent += `(Симулированный вывод: "Мир пернатых приветствует вас на P#!")\n`;
                     outputConsole.textContent += `На самом деле для этого нужен собственный компилятор P# и среда выполнения.\n`;
                }
                else {
                    outputConsole.textContent += `--- Имитация выполнения для ${language.toUpperCase()} ---\n`;
                    outputConsole.textContent += `Для реальной компиляции/интерпретации "${language.toUpperCase()}" требуется серверный компонент (бэкенд).\n`;
                    outputConsole.textContent += `Вывод: "Это симулированный результат для ${language.toUpperCase()}!"\n`;
                }
            });

            // Переключение вкладок панели (Вывод, Проблемы, Терминал)
            panelTabs.addEventListener('click', (event) => {
                document.querySelectorAll('.panel-tab').forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                const contentToShow = event.target.dataset.panelContent;

                outputConsole.style.display = 'block';
                outputConsole.textContent = '';

                if (contentToShow === 'output') {
                    outputConsole.textContent = "Здесь будет вывод вашего кода после запуска.";
                } else if (contentToShow === 'problems') {
                    outputConsole.textContent = "Проблем не обнаружено (это имитация).";
                } else if (contentToShow === 'terminal') {
                    outputConsole.textContent = "Это имитация терминала.\nНастоящий терминал требует серверного компонента и WebSockets.";
                }
            });

            // --- File Menu Dropdown Logic ---
            fileMenuItem.addEventListener('click', (event) => {
                // Toggle dropdown visibility
                const isVisible = fileDropdown.style.display === 'block';
                fileDropdown.style.display = isVisible ? 'none' : 'block';
                event.stopPropagation(); // Prevent document click from immediately closing
            });

            // Handle clicks on dropdown items
            newFileOption.addEventListener('click', () => {
                const fileName = prompt('Введите имя нового файла (например, new.js):');
                if (fileName) {
                    const newFileId = addFile(fileName, '');
                    openFile(newFileId);
                }
                fileDropdown.style.display = 'none';
            });

            openFileOption.addEventListener('click', () => {
                openLocalFile();
                fileDropdown.style.display = 'none';
            });

            openFolderOption.addEventListener('click', () => {
                openFolder();
                fileDropdown.style.display = 'none';
            });

            saveAsOption.addEventListener('click', () => {
                saveCurrentFileAs();
                fileDropdown.style.display = 'none';
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', (e) => {
                if (!fileMenuItem.contains(e.target) && !fileDropdown.contains(e.target)) {
                    fileDropdown.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
